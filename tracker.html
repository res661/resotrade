<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RESOTRADE - Финансовый трекер</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/MorphSVGPlugin.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    :root {
        /* Main Colors */
        --bg-primary: #0a0e17;
        --bg-secondary: #111827;
        --bg-tertiary: #1f2937;
        --bg-card: linear-gradient(145deg, #131b2e, #1a2540);
        --glass: rgba(255, 255, 255, 0.05);
        --glass-hover: rgba(255, 255, 255, 0.08);
        
        /* Accent Colors */
        --accent-primary: #4f46e5;
        --accent-primary-hover: #6366f1;
        --accent-primary-glow: rgba(79, 70, 229, 0.5);
        --accent-secondary: #8b5cf6;
        --accent-tertiary: #ec4899;
        --accent-quaternary: #06b6d4;
        
        /* Gradient Colors */
        --gradient-primary: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
        --gradient-secondary: linear-gradient(135deg, var(--accent-tertiary) 0%, var(--accent-quaternary) 100%);
        --gradient-text: linear-gradient(135deg, #fff 0%, #c7d2fe 100%);
        
        /* Text Colors */
        --text-primary: rgba(255, 255, 255, 0.95);
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-tertiary: rgba(255, 255, 255, 0.5);
        
        /* Status Colors */
        --positive: #10b981;
        --positive-light: rgba(16, 185, 129, 0.2);
        --negative: #ef4444;
        --negative-light: rgba(239, 68, 68, 0.2);
        --warning: #f59e0b;
        --info: #3b82f6;
        
        /* Border Colors */
        --border: rgba(255, 255, 255, 0.1);
        --border-hover: rgba(255, 255, 255, 0.2);
        
        /* Shadows */
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
        --shadow-glow: 0 0 20px var(--accent-primary-glow);
        --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
        
        /* Transitions */
        --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        
        /* Sizes */
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 20px;
        --radius-xl: 28px;
        --radius-full: 9999px;
        
        /* Spacing */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 3rem;
        
        /* Font */
        --font-sans: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        --font-display: 'Montserrat', var(--font-sans);
    }

    :root.light-theme {
        --bg-primary: #f8fafc;
        --bg-secondary: #f1f5f9;
        --bg-tertiary: #e2e8f0;
        --bg-card: linear-gradient(145deg, #f8fafc, #f1f5f9);
        --glass: rgba(0, 0, 0, 0.03);
        --glass-hover: rgba(0, 0, 0, 0.06);
        
        --accent-primary: #4f46e5;
        --accent-primary-hover: #4338ca;
        --accent-primary-glow: rgba(79, 70, 229, 0.3);
        --accent-secondary: #8b5cf6;
        --accent-tertiary: #ec4899;
        --accent-quaternary: #06b6d4;
        
        --gradient-text: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        
        --text-primary: rgba(15, 23, 42, 0.95);
        --text-secondary: rgba(15, 23, 42, 0.7);
        --text-tertiary: rgba(15, 23, 42, 0.5);
        
        /* Status Colors */
        --positive: #059669;
        --positive-light: rgba(5, 150, 105, 0.2);
        --negative: #dc2626;
        --negative-light: rgba(220, 38, 38, 0.2);
        --warning: #f59e0b;
        --info: #3b82f6;
        
        /* Border Colors */
        --border: rgba(0, 0, 0, 0.1);
        --border-hover: rgba(0, 0, 0, 0.2);
        
        /* Shadows */
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
    }

    /* Pink Japanese Theme */
    :root.pink-theme {
        --bg-primary: #1a0f1f;
        --bg-secondary: #2d1535;
        --bg-tertiary: #3d1d47;
        --bg-card: linear-gradient(145deg, #2d1535, #3d1d47);
        --glass: rgba(255, 255, 255, 0.05);
        --glass-hover: rgba(255, 255, 255, 0.08);
        
        --accent-primary: #ff69b4;
        --accent-primary-hover: #ff1493;
        --accent-primary-glow: rgba(255, 105, 180, 0.5);
        --accent-secondary: #ff69b4;
        --accent-tertiary: #ff1493;
        --accent-quaternary: #ff69b4;
        
        --gradient-primary: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
        --gradient-secondary: linear-gradient(135deg, var(--accent-tertiary) 0%, var(--accent-quaternary) 100%);
        --gradient-text: linear-gradient(135deg, #fff 0%, #ffb7e5 100%);
        
        --text-primary: rgba(255, 255, 255, 0.95);
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-tertiary: rgba(255, 255, 255, 0.5);
        
        --positive: #ff69b4;
        --positive-light: rgba(255, 105, 180, 0.2);
        --negative: #ef4444;
        --negative-light: rgba(239, 68, 68, 0.2);
        --warning: #f59e0b;
        --info: #3b82f6;
        
        --border: rgba(255, 255, 255, 0.1);
        --border-hover: rgba(255, 255, 255, 0.2);
        
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
        --shadow-glow: 0 0 20px var(--accent-primary-glow);
        --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
    }

    /* Общие стили */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: var(--font-sans);
    }

    body {
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        padding: var(--spacing-xl);
        overflow-x: hidden;
        position: relative;
        transition: background-color 0.5s ease;
        line-height: 1.5;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 10% 20%, rgba(79, 70, 229, 0.08) 0%, transparent 30%),
            radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 30%),
            radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.05) 0%, transparent 50%);
        z-index: -1;
        animation: gradientMove 20s ease-in-out infinite alternate;
    }

    .pink-theme body::before {
        background: 
            radial-gradient(circle at 10% 20%, rgba(236, 72, 153, 0.08) 0%, transparent 30%),
            radial-gradient(circle at 90% 80%, rgba(244, 114, 182, 0.08) 0%, transparent 30%),
            radial-gradient(circle at 50% 50%, rgba(192, 38, 211, 0.05) 0%, transparent 50%);
    }

    @keyframes gradientMove {
        0% { background-position: 0% 0%; }
        100% { background-position: 100% 100%; }
    }

    h1, h2, h3, h4, h5, h6 {
        font-family: var(--font-display);
        font-weight: 700;
        letter-spacing: -0.025em;
        color: var(--text-primary);
    }

    h1 {
        font-size: 2.75rem;
        margin-bottom: var(--spacing-md);
        letter-spacing: -0.05em;
    }

    h2 {
        font-size: 1.75rem;
        margin-bottom: var(--spacing-sm);
    }

    h3 {
        font-size: 1.25rem;
        margin-bottom: var(--spacing-xs);
        color: var(--text-secondary);
        font-weight: 600;
    }

    p {
        margin-bottom: var(--spacing-md);
        color: var(--text-secondary);
    }

    small {
        font-size: 0.875rem;
        color: var(--text-tertiary);
    }

    .dashboard {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        gap: var(--spacing-xl);
        grid-template-columns: repeat(12, 1fr);
    }

    .card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-card);
        padding: var(--spacing-xl);
        transition: var(--transition-normal);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
        transform-style: preserve-3d;
        perspective: 1000px;
    }

    .card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(
            135deg, 
            transparent 0%, 
            transparent 20%, 
            rgba(79, 70, 229, 0.05) 40%, 
            rgba(139, 92, 246, 0.05) 60%, 
            rgba(236, 72, 153, 0.05) 80%, 
            transparent 100%
        );
        z-index: -1;
        opacity: 0;
        transition: opacity 0.5s ease;
    }

    .pink-theme .card::before {
        background: linear-gradient(
            135deg, 
            transparent 0%, 
            transparent 20%, 
            rgba(236, 72, 153, 0.05) 40%, 
            rgba(244, 114, 182, 0.05) 60%, 
            rgba(192, 38, 211, 0.05) 80%, 
            transparent 100%
        );
    }

    .card:hover::before {
        opacity: 1;
        animation: cardGradient 3s linear infinite;
    }

    @keyframes cardGradient {
        0% { background-position: 0% 0%; }
        100% { background-position: 100% 100%; }
    }

    .card:hover {
        transform: translateY(-8px) rotateX(2deg) rotateY(2deg);
        box-shadow: 
            0 20px 25px -5px rgba(0, 0, 0, 0.3),
            0 10px 10px -5px rgba(0, 0, 0, 0.2),
            0 0 20px var(--accent-primary-glow);
        border-color: var(--border-hover);
    }

    .card-glow {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
        opacity: 0.9;
        box-shadow: 0 0 10px var(--accent-primary-glow);
    }

    .balance-card {
        grid-column: span 12;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .balance-card h1 {
        font-size: 3.5rem;
        margin-bottom: var(--spacing-xs);
        background: linear-gradient(135deg, #fff 0%, var(--accent-primary) 50%, var(--accent-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        background-size: 200% 200%;
        animation: gradientText 5s ease infinite;
        text-shadow: 0 0 30px var(--accent-primary-glow);
    }

    .pink-theme .balance-card h1 {
        background: linear-gradient(135deg, #fff 0%, var(--accent-primary) 50%, var(--accent-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    @keyframes gradientText {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .profit-loss {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-xl);
    }

    .profit-loss-card {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .profit-loss-card h2 {
        font-size: 2.25rem;
        position: relative;
        display: inline-block;
    }

    .income h2 {
        color: var(--positive);
        text-shadow: 0 0 20px var(--positive-light);
    }

    .income h2::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 0;
        height: 3px;
        background: var(--positive);
        transition: width 0.5s ease;
    }

    .income:hover h2::after {
        width: 100%;
    }

    .expense h2 {
        color: var(--negative);
        text-shadow: 0 0 20px var(--negative-light);
    }

    .expense h2::after {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 0;
        height: 3px;
        background: var(--negative);
        transition: width 0.5s ease;
    }

    .expense:hover h2::after {
        width: 100%;
    }

    .chart-container {
        grid-column: span 12;
        height: 400px;
        position: relative;
        overflow: hidden;
    }

    .chart-glow {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(0deg, rgba(79, 70, 229, 0.1) 0%, transparent 100%);
        pointer-events: none;
        z-index: 1;
        animation: pulseGlow 3s ease-in-out infinite alternate;
    }

    .pink-theme .chart-glow {
        background: linear-gradient(0deg, rgba(236, 72, 153, 0.1) 0%, transparent 100%);
    }

    @keyframes pulseGlow {
        0% { opacity: 0.3; }
        100% { opacity: 0.7; }
    }

    .calendar-container {
        display: none;
        grid-column: span 12;
        height: 400px;
        position: relative;
        overflow: auto;
    }

    .calendar-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(100px, 1fr));
        gap: var(--spacing-sm);
        min-width: 700px;
    }

    .calendar-day {
        background: var(--glass);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        text-align: center;
        cursor: pointer;
        transition: var(--transition-normal);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
    }

    .calendar-day::before {
        content: '';
        position: absolute;
        top: -100%;
        left: -100%;
        width: 300%;
        height: 300%;
        background: radial-gradient(circle, rgba(79, 70, 229, 0.2) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.5s ease;
    }

    .pink-theme .calendar-day::before {
        background: radial-gradient(circle, rgba(236, 72, 153, 0.2) 0%, transparent 70%);
    }

    .calendar-day:hover {
        background: var(--glass-hover);
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        border-color: var(--border-hover);
    }

    @keyframes rotateGradient {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .calendar-day.today {
        border: 2px solid var(--accent-primary);
        box-shadow: 0 0 15px var(--accent-primary-glow);
    }

    .calendar-day .day-number {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        position: relative;
        z-index: 1;
    }

    .calendar-day .day-balance {
        font-size: 0.875rem;
        position: relative;
        z-index: 1;
    }

    .positive-balance {
        color: var(--positive);
        text-shadow: 0 0 5px var(--positive-light);
    }

    .negative-balance {
        color: var(--negative);
        text-shadow: 0 0 5px var(--negative-light);
    }

    .search-container {
        grid-column: span 12;
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .view-toggle-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: var(--transition-normal);
        min-width: 120px;
    }

    .view-toggle-btn:hover {
        background: var(--glass-hover);
        border-color: var(--border-hover);
        transform: translateY(-2px);
    }

    .view-toggle-btn.active {
        background: var(--gradient-primary);
        color: white;
        border: none;
    }

    .search-input {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: 0.95rem;
        flex: 1;
        min-width: 150px;
        transition: var(--transition-normal);
        outline: none;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .search-input:focus {
        border-color: var(--accent-primary);
        box-shadow: 
            inset 0 2px 4px rgba(0, 0, 0, 0.1),
            0 0 0 3px var(--accent-primary-glow);
        animation: pulseBorder 1.5s ease-in-out infinite;
    }

    @keyframes pulseBorder {
        0%, 100% { border-color: var(--accent-primary); }
        50% { border-color: var(--accent-secondary); }
    }

    .transactions-list {
        grid-column: span 12;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        max-height: 500px;
        overflow-y: auto;
        padding-right: var(--spacing-sm);
    }

    .transactions-grid {
        grid-column: span 12;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); /* Увеличиваем минимальную ширину карточек */
        gap: var(--spacing-xl);
        max-height: 700px;
        overflow-y: auto;
        padding-right: var(--spacing-sm);
        padding-bottom: var(--spacing-xl);
    }

    .transaction-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        border: 1px solid var(--border);
        transition: var(--transition-normal);
        animation: itemAppear 0.6s ease;
        position: relative;
        overflow: hidden;
        min-height: 250px; /* Увеличиваем минимальную высоту */
        height: 100%;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-sm);
        width: 100%; /* Гарантируем, что карточка будет занимать всю доступную ширину */
    }

    .transaction-card .transaction-info {
        flex-grow: 1;
        padding-right: 70px; /* Отступ справа для кнопок */
        overflow: visible; /* Показываем весь контент */
        display: flex;
        flex-direction: column;
    }

    .transaction-card .transaction-actions {
        position: absolute;
        right: 15px;
        top: 40px; /* Смещаем кнопки вверх */
        transform: translateY(0); /* Убираем смещение от центра */
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .transaction-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--shadow-md);
        border-color: var(--border-hover);
    }

    .transaction-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 6px;
        height: 100%;
        background: var(--gradient-primary);
        opacity: 0.7;
        transition: width 0.3s ease;
    }

    .transaction-card:hover::before {
        width: 10px;
    }

    .transaction-card.income::before {
        background: linear-gradient(to bottom, var(--positive), var(--positive-light));
    }

    .transaction-card.expense::before {
        background: linear-gradient(to bottom, var(--negative), var(--negative-light));
    }

    .transaction-card h4 {
        font-size: 1rem; /* Уменьшаем шрифт заголовка */
        margin-bottom: 10px;
        font-weight: 700;
        word-wrap: break-word; /* Перенос длинных слов */
        line-height: 1.3; /* Уменьшаем межстрочный интервал */
        max-height: none; /* Убираем ограничение по высоте */
        overflow-wrap: break-word; /* Улучшаем перенос длинных слов */
        hyphens: auto; /* Добавляем переносы */
    }

    .transaction-card small {
        font-size: 0.8rem; /* Уменьшаем размер шрифта даты */
        opacity: 0.8;
        display: block; /* Гарантируем перенос на новую строку */
        margin-bottom: 4px;
    }

    .transaction-card .transaction-amount {
        margin-top: auto; /* Размещаем сумму внизу карточки */
        padding-top: 10px; /* Добавляем отступ сверху */
        font-size: 1.3rem; /* Уменьшаем размер шрифта для суммы */
        font-weight: 700;
        display: block;
        font-family: var(--font-display);
    }

    .transaction-card .amount-positive {
        color: var(--positive);
        text-shadow: 0 0 10px var(--positive-light);
    }

    .transaction-card .amount-negative {
        color: var(--negative);
        text-shadow: 0 0 10px var(--negative-light);
    }

    .transaction-card .profit-percent {
        font-size: 0.85rem; /* Уменьшаем размер шрифта для процентов */
        padding: 2px 6px; /* Уменьшаем отступы */
        border-radius: var(--radius-full);
        margin-left: 4px;
        vertical-align: middle;
        background: var(--glass);
        white-space: nowrap; /* Предотвращаем перенос строки в проценте */
    }

    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg);
        background: var(--bg-card);
        border-radius: var(--radius-md);
        transition: var(--transition-normal);
        border: 1px solid var(--border);
        animation: itemAppear 0.6s ease;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .transaction-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .transaction-item:hover::before {
        opacity: 1;
    }

    .transaction-item:hover {
        transform: translateX(8px) scale(1.02);
        background: var(--glass-hover);
        box-shadow: var(--shadow-md);
        border-color: var(--border-hover);
    }

    .transaction-info {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .transaction-actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .transaction-amount {
        font-weight: 600;
        font-size: 1.1rem;
        position: relative;
    }

    .profit-percent {
        font-size: 0.85rem;
        font-weight: 500;
        margin-left: 4px;
        opacity: 0.85;
        display: inline-block;
        vertical-align: middle;
        background: var(--glass);
        padding: 1px 6px;
        border-radius: var(--radius-full);
        transition: var(--transition-normal);
    }

    .transaction-item:hover .profit-percent {
        opacity: 1;
        background: var(--glass-hover);
        box-shadow: var(--shadow-sm);
    }

    .amount-positive .profit-percent {
        color: var(--positive);
    }

    .amount-positive {
        color: var(--positive);
    }

    .amount-positive::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--positive);
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.3s ease;
    }

    .transaction-item:hover .amount-positive::after {
        transform: scaleX(1);
        transform-origin: left;
    }

    .amount-negative {
        color: var(--negative);
    }

    .amount-negative::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--negative);
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.3s ease;
    }

    .transaction-item:hover .amount-negative::after {
        transform: scaleX(1);
        transform-origin: left;
    }

    .btn {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 500;
        border: none;
        transition: var(--transition-normal);
        font-size: 1rem;
    }

    .btn-primary {
        background: var(--gradient-primary);
        color: white;
        box-shadow: 0 0 10px var(--accent-primary-glow);
    }
    
    .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
    
    .btn:hover {
        transform: translateY(-2px);
    }
    
    .btn:active {
        transform: translateY(1px);
    }
    
    .btn-primary:hover {
        box-shadow: 0 0 15px var(--accent-primary-glow);
    }

    .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
        border-radius: var(--radius-full);
        position: relative;
    }

    .btn-icon::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: inherit;
        background: var(--gradient-primary);
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .btn-icon:hover::after {
        opacity: 1;
    }

    .btn-large {
        padding: var(--spacing-md) var(--spacing-lg);
        font-size: 1rem;
    }

    .btn-group {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
    }

    .btn-group .btn {
        flex: 1;
    }

    .btn-active {
        background: var(--gradient-primary);
        color: white;
        border: none;
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
    }

    .add-btn {
        position: fixed;
        bottom: var(--spacing-xl);
        right: var(--spacing-xl);
        width: 64px;
        height: 64px;
        border-radius: var(--radius-full);
        background: var(--gradient-primary);
        color: white;
        font-size: 1.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition-normal);
        border: none;
        box-shadow: 
            var(--shadow-lg), 
            0 0 20px var(--accent-primary-glow);
        z-index: 100;
        overflow: hidden;
    }

    .add-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--gradient-secondary);
        opacity: 0;
        transition: opacity 0.5s ease;
    }

    .add-btn:hover::before {
        opacity: 1;
    }

    .add-btn:hover {
        transform: scale(1.1) rotate(90deg);
        box-shadow: 
            var(--shadow-lg), 
            0 0 30px var(--accent-primary-glow);
    }

    .add-btn span {
        position: relative;
        z-index: 1;
    }

    .nav-bar {
        position: fixed;
        top: var(--spacing-xl);
        right: var(--spacing-xl);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        z-index: 100;
    }

    .nav-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-full);
        background: var(--bg-card);
        color: var(--accent-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition-normal);
        border: 1px solid var(--border);
        font-size: 1.25rem;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .nav-icon::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .nav-icon:hover {
        transform: translateY(-4px);
        color: white;
        box-shadow: var(--shadow-glow);
    }

    .nav-icon:hover::before {
        opacity: 1;
    }

    .nav-icon ion-icon {
        position: relative;
        z-index: 1;
    }

    /* Tooltip styles for nav icons */
    .nav-icon-wrapper {
        position: relative;
    }

    .nav-tooltip {
        position: absolute;
        top: 50%;
        right: 100%;
        transform: translateY(-50%);
        background: var(--bg-card);
        color: var(--text-primary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        white-space: nowrap;
        margin-right: var(--spacing-md);
        opacity: 0;
        visibility: hidden;
        transition: var(--transition-normal);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-md);
        pointer-events: none;
        z-index: 101;
    }

    .nav-icon-wrapper:hover .nav-tooltip {
        opacity: 1;
        visibility: visible;
    }

    /* Theme toggle styles */
    .theme-toggle {
        position: fixed;
        top: var(--spacing-xl);
        left: var(--spacing-xl);
        width: 48px;
        height: 48px;
        border-radius: var(--radius-full);
        background: var(--bg-card);
        color: var(--accent-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition-normal);
        border: 1px solid var(--border);
        z-index: 100;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .theme-toggle::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .theme-toggle:hover {
        transform: translateY(-4px);
        color: white;
        box-shadow: var(--shadow-glow);
    }

    .theme-toggle:hover::before {
        opacity: 1;
    }

    .theme-toggle svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        position: relative;
        z-index: 1;
    }

    /* Theme transition effect */
    .theme-transition {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        z-index: 9999;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .theme-menu {
        position: fixed;
        top: calc(var(--spacing-xl) + 60px);
        left: var(--spacing-xl);
        background: var(--bg-card);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
        padding: var(--spacing-sm);
        z-index: 100;
        display: none;
        flex-direction: column;
        gap: var(--spacing-sm);
        min-width: 150px;
    }

    .theme-menu.active {
        display: flex;
        animation: fadeIn 0.3s ease forwards;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .theme-option {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .theme-option:hover {
        background: var(--glass-hover);
    }

    .theme-option.active {
        background: var(--accent-primary);
        color: white;
    }

    .theme-icon {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .switch-view {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: var(--bg-card);
        color: var(--text-primary);
        width: 44px;
        height: 88px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition-normal);
        z-index: 10;
        cursor: pointer;
        border: 1px solid var(--border);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .switch-view::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .switch-view:hover {
        color: white;
        width: 54px;
        box-shadow: var(--shadow-md);
    }

    .switch-view:hover::before {
        opacity: 1;
    }

    .switch-view span {
        position: relative;
        z-index: 1;
        font-size: 1.5rem;
    }

    .switch-view.left {
        left: -1px;
        border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
        justify-content: flex-end;
        padding-right: 10px;
    }

    .switch-view.right {
        right: -1px;
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        justify-content: flex-start;
        padding-left: 10px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
    }

    .modal-content {
        background: var(--bg-card);
        margin: 10% auto;
        padding: var(--spacing-xl);
        border: 1px solid var(--border);
        width: 90%;
        max-width: 500px;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        animation: modalAppear 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
        overflow: hidden;
        transform: translateZ(0);
    }

    .modal-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
        z-index: 1;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        position: relative;
    }

    .modal-body {
        margin-bottom: var(--spacing-lg);
        position: relative;
        max-height: 70vh;
        overflow-y: auto;
        padding-right: var(--spacing-sm);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
        position: relative;
        margin-top: var(--spacing-xl);
    }

    .modal-footer .btn {
        min-width: 120px;
        padding: var(--spacing-md) var(--spacing-lg);
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-footer .btn:hover {
        transform: translateY(-3px);
    }

    .modal-footer .btn-primary {
        background: var(--gradient-primary);
    }

    @keyframes modalAppear {
        0% { opacity: 0; transform: scale(0.9) translateY(20px); }
        100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    .close {
        color: var(--text-tertiary);
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition-fast);
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-full);
    }

    .close:hover {
        color: var(--accent-primary);
        background: var(--glass);
        transform: rotate(90deg);
    }

    .form-group {
        margin-bottom: var(--spacing-md);
        position: relative;
    }

    .form-group label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: 500;
        color: var(--text-secondary);
        transition: var(--transition-normal);
    }

    .form-group:focus-within label {
        color: var(--accent-primary);
    }

    .form-control {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        font-size: 1rem;
        width: 100%;
        transition: var(--transition-normal);
        outline: none;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-control:focus {
        border-color: var(--accent-primary);
        box-shadow: 
            inset 0 2px 4px rgba(0, 0, 0, 0.1),
            0 0 0 3px var(--accent-primary-glow);
    }

    .form-control:hover:not(:focus) {
        border-color: var(--accent-secondary);
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23718096' strokeWidth='2' strokeLinecap='round' strokeLinejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right var(--spacing-md) center;
        background-size: 16px;
        padding-right: var(--spacing-xl);
    }

    .telegram-buttons {
        display: flex;
        justify-content: center;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .telegram-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-radius: var(--radius-md);
        text-decoration: none;
        transition: var(--transition-normal);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
        font-weight: 500;
        width: 180px;
    }

    .telegram-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--gradient-primary);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .telegram-button:hover {
        color: white;
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
    }

    .telegram-button:hover::before {
        opacity: 1;
    }

    .telegram-button ion-icon, 
    .telegram-button span {
        position: relative;
        z-index: 1;
    }

    .telegram-button ion-icon {
        font-size: 1.25rem;
    }

    .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
    }

    .confirm-modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-card);
        padding: var(--spacing-lg) var(--spacing-xl);
        border-radius: var(--radius-lg);
        min-width: 300px;
        box-shadow: var(--shadow-lg);
        text-align: center;
        border: 1px solid var(--border);
        animation: scaleIn 0.3s ease;
    }

    .confirm-modal-content h3 {
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
        font-weight: 600;
    }

    .confirm-buttons {
        display: flex;
        justify-content: center;
        gap: var(--spacing-lg);
        margin-top: var(--spacing-xl);
    }
    
    .confirm-buttons .btn {
        min-width: 120px;
        padding: var(--spacing-md) var(--spacing-lg);
        font-weight: 600;
        animation: fadeInUp 0.3s ease forwards;
        animation-delay: 0.1s;
        opacity: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .confirm-buttons .btn-primary {
        background: var(--gradient-primary);
        box-shadow: 0 0 10px var(--accent-primary-glow);
        color: white;
        font-weight: 600;
        border: none;
        transition: all 0.3s ease;
    }
    
    .confirm-buttons .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border);
        transition: all 0.3s ease;
    }
    
    .confirm-buttons .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 15px var(--accent-primary-glow);
    }
    
    .confirm-buttons .btn-primary:active {
        transform: translateY(1px);
        box-shadow: 0 0 5px var(--accent-primary-glow);
    }
    
    .confirm-buttons .btn-secondary:hover {
        background: var(--bg-secondary);
        transform: translateY(-2px);
    }
    
    .confirm-buttons .btn-secondary:active {
        transform: translateY(1px);
    }
    
    /* Стили для светлой темы */
    .light-theme .confirm-buttons .btn-primary {
        box-shadow: 0 2px 10px rgba(79, 70, 229, 0.4);
    }
    
    .light-theme .confirm-buttons .btn-secondary {
        background: #f1f5f9;
        color: #334155;
        border: 1px solid #cbd5e1;
    }
    
    .light-theme .confirm-buttons .btn-secondary:hover {
        background: #e2e8f0;
    }

    .calculation-result {
        background: var(--bg-tertiary);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-top: var(--spacing-md);
        border: 1px solid var(--border);
        animation: fadeIn 0.5s ease;
        position: relative;
        overflow: hidden;
        z-index: 10;
        box-shadow: var(--shadow-md);
    }

    .calculation-result::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--gradient-primary);
    }

    .calculation-result p {
        margin-bottom: var(--spacing-xs);
        position: relative;
        padding-left: var(--spacing-sm);
    }

    .calculation-result p:last-child {
        margin-bottom: 0;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
        border-radius: var(--radius-full);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--gradient-primary);
        border-radius: var(--radius-full);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--gradient-secondary);
    }

    /* Animations */
    @keyframes itemAppear {
        0% { opacity: 0; transform: translateY(20px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    @keyframes floatUp {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    @keyframes fadeIn {
        0% { opacity: 0; }
        100% { opacity: 1; }
    }
    
    @keyframes scaleIn {
        0% { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    /* Notification styles */
    .notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: var(--radius-md);
        color: white;
        font-weight: 500;
        z-index: 9999;
        opacity: 0;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-md);
    }

    .notification.success {
        background: linear-gradient(135deg, var(--positive), #34d399);
    }

    .notification.error {
        background: linear-gradient(135deg, var(--negative), #f87171);
    }

    .notification.info {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    }

    /* Particle effects */
    .particle {
        position: fixed;
        width: 3px;
        height: 3px;
        background: var(--accent-primary);
        border-radius: var(--radius-full);
        pointer-events: none;
        opacity: 0.3;
        z-index: -1;
        filter: blur(1px);
    }

    .star {
        position: fixed;
        width: 2px;
        height: 2px;
        background: white;
        border-radius: var(--radius-full);
        pointer-events: none;
        opacity: 0.5;
        z-index: -1;
        animation: starFloat 15s linear infinite;
        filter: blur(0.5px);
    }

    .sparkle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--accent-primary);
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
        z-index: 10;
        filter: blur(0.5px);
        box-shadow: 0 0 10px var(--accent-primary-glow);
    }

    /* Cherry blossom petals for pink theme */
    .cherry-blossom {
        position: fixed;
        width: 15px;
        height: 15px;
        background-image: radial-gradient(circle at 30% 30%, white 0%, var(--accent-tertiary) 100%);
        border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
        pointer-events: none;
        z-index: -1;
        opacity: 0.7;
        filter: blur(0.5px);
        animation: fallDown 10s linear forwards;
        display: none;
    }

    .pink-theme .cherry-blossom {
        display: block;
    }

    @keyframes fallDown {
        0% {
            transform: translateY(-100px) rotate(0deg) scale(0.6);
            opacity: 0;
        }
        10% {
            opacity: 0.7;
        }
        100% {
            transform: translateY(calc(100vh + 100px)) rotate(360deg) scale(0.6);
            opacity: 0;
        }
    }

    @keyframes sparkleAnimation {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1); opacity: 1; }
        100% { transform: scale(0); opacity: 0; }
    }

    @keyframes starFloat {
        0% { transform: translateY(100vh) rotate(0deg); }
        100% { transform: translateY(-100vh) rotate(360deg); }
    }

    /* Responsive styles */
    @media (max-width: 768px) {
        body {
            padding: var(--spacing-md);
        }

        .dashboard {
            gap: var(--spacing-md);
        }

        .profit-loss {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }

        .telegram-buttons {
            flex-direction: column;
        }

        .nav-bar {
            top: auto;
            bottom: var(--spacing-xl);
            right: var(--spacing-xl);
            flex-direction: row;
        }

        .add-btn {
            bottom: var(--spacing-xl);
            right: calc(var(--spacing-xl) + 60px + var(--spacing-md));
        }
        
        .theme-menu {
            top: auto;
            bottom: calc(var(--spacing-xl) + 60px);
            left: var(--spacing-xl);
        }
    }

    /* Glowing cursor effect */
    .glow-cursor {
        position: fixed;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: radial-gradient(circle, var(--accent-primary-glow) 0%, transparent 70%);
        pointer-events: none;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
        mix-blend-mode: screen;
    }

    /* Floating elements animation */
    .float-animation {
        animation: floatUp 5s ease-in-out infinite;
    }

    /* Pulse animation for important elements */
    .pulse-animation {
        animation: pulse 3s ease-in-out infinite;
    }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
}

.stats-item {
    background: var(--bg-tertiary);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    text-align: center;
    border: 1px solid var(--border);
    transition: var(--transition-normal);
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.stats-item::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(79, 70, 229, 0.1) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.5s ease;
}

.pink-theme .stats-item::before {
    background: radial-gradient(circle, rgba(236, 72, 153, 0.1) 0%, transparent 70%);
}

.stats-item:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
    border-color: var(--border-hover);
}

.stats-item:hover::before {
    opacity: 1;
    animation: rotateGradient 10s linear infinite;
}

.stats-item h3 {
    margin-bottom: var(--spacing-sm);
    color: var(--text-secondary);
}

.stats-item p {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: var(--spacing-xs);
    color: var(--text-primary);
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-primary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    opacity: 0;
    transform: translateY(10px);
    animation: fadeInUp 0.5s forwards 0.2s;
}

@keyframes fadeInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stats-item p.positive {
    background: linear-gradient(135deg, var(--positive) 0%, #34d399 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stats-item p.negative {
    background: linear-gradient(135deg, var(--negative) 0%, #f87171 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Theme Toggle and Menu Styles */
.theme-toggle {
    position: fixed;
    top: var(--spacing-xl);
    left: var(--spacing-xl);
    width: 48px;
    height: 48px;
    border-radius: var(--radius-full);
    background: var(--bg-card);
    color: var(--accent-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition-normal);
    border: 1px solid var(--border);
    z-index: 100;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.theme-toggle::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--gradient-primary);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.theme-toggle:hover {
    transform: translateY(-4px);
    color: white;
    box-shadow: var(--shadow-glow);
}

.theme-toggle:hover::before {
    opacity: 1;
}

.theme-toggle svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    position: relative;
    z-index: 1;
}

.theme-menu {
    position: fixed;
    top: calc(var(--spacing-xl) + 60px);
    left: var(--spacing-xl);
    background: var(--bg-card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    padding: var(--spacing-sm);
    z-index: 100;
    display: none;
    flex-direction: column;
    gap: var(--spacing-sm);
    min-width: 150px;
}

.theme-menu.active {
    display: flex;
    animation: fadeIn 0.3s ease forwards;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.theme-option {
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.theme-option:hover {
    background: var(--glass-hover);
}

.theme-option.active {
    background: var(--accent-primary);
    color: white;
}

.theme-icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Effects */
.sparkle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: var(--accent-primary);
    border-radius: 50%;
    opacity: 0;
    pointer-events: none;
    z-index: 10;
    filter: blur(0.5px);
    box-shadow: 0 0 10px var(--accent-primary-glow);
}

.glow-cursor {
    position: fixed;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: radial-gradient(circle, var(--accent-primary-glow) 0%, transparent 70%);
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease;
    mix-blend-mode: screen;
}

@keyframes sparkleAnimation {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0); opacity: 0; }
}

/* Cherry Blossoms (Pink Theme) */
.cherry-blossom {
    position: fixed;
    width: 15px;
    height: 15px;
    background-image: radial-gradient(circle at 30% 30%, white 0%, var(--accent-tertiary) 100%);
    border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
    pointer-events: none;
    z-index: -1;
    opacity: 0.7;
    filter: blur(0.5px);
    animation: fallDown 10s linear forwards;
    display: none;
}

.pink-theme .cherry-blossom {
    display: block;
}

@keyframes fallDown {
    0% {
        transform: translateY(-100px) rotate(0deg) scale(0.6);
        opacity: 0;
    }
    10% {
        opacity: 0.7;
    }
    100% {
        transform: translateY(calc(100vh + 100px)) rotate(360deg) scale(0.6);
        opacity: 0;
    }
}

/* Media Queries */
@media (max-width: 768px) {
    .theme-toggle {
        top: auto;
        bottom: var(--spacing-xl);
        left: var(--spacing-xl);
    }
    
    .theme-menu {
        top: auto;
        bottom: calc(var(--spacing-xl) + 60px);
        left: var(--spacing-xl);
    }
}

    /* Стили для анимации загрузки */
    .loader-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-primary);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
    }

    .loader {
        position: relative;
        width: 300px;
        height: 300px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .loader-logo {
        font-family: var(--font-display);
        font-size: 3.5rem;
        font-weight: 800;
        background: var(--gradient-text);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        position: relative;
        display: flex;
        gap: 0.2rem;
    }

    .loader-logo span {
        display: inline-block;
        opacity: 0;
        transform: translateY(20px);
    }

    .loader-logo span:nth-child(1) { animation: letterAppear 0.5s ease forwards 0.1s; }
    .loader-logo span:nth-child(2) { animation: letterAppear 0.5s ease forwards 0.2s; }
    .loader-logo span:nth-child(3) { animation: letterAppear 0.5s ease forwards 0.3s; }
    .loader-logo span:nth-child(4) { animation: letterAppear 0.5s ease forwards 0.4s; }
    .loader-logo span:nth-child(5) { animation: letterAppear 0.5s ease forwards 0.5s; }
    .loader-logo span:nth-child(6) { animation: letterAppear 0.5s ease forwards 0.6s; }
    .loader-logo span:nth-child(7) { animation: letterAppear 0.5s ease forwards 0.7s; }
    .loader-logo span:nth-child(8) { animation: letterAppear 0.5s ease forwards 0.8s; }
    .loader-logo span:nth-child(9) { animation: letterAppear 0.5s ease forwards 0.9s; }

    .loader-circle {
        position: absolute;
        width: 100%;
        height: 100%;
        border: 4px solid transparent;
        border-radius: 50%;
        animation: rotate 3s linear infinite;
    }

    .loader-circle::before {
        content: '';
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border: 4px solid transparent;
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: rotate 2s linear infinite;
    }

    .loader-circle::after {
        content: '';
        position: absolute;
        top: -8px;
        left: -8px;
        right: -8px;
        bottom: -8px;
        border: 4px solid transparent;
        border-top-color: var(--accent-secondary);
        border-radius: 50%;
        animation: rotate 1.5s linear infinite;
    }

    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes letterAppear {
        0% { 
            opacity: 0;
            transform: translateY(20px);
        }
        100% { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    .loader-fade-out {
        opacity: 0;
        pointer-events: none;
    }

    .achievement-progress {
        margin-top: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        overflow: hidden;
        height: 6px;
    }
    
    .achievement-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-secondary) 0%, var(--accent-primary) 100%);
        box-shadow: 0 0 10px var(--accent-primary);
        border-radius: 5px;
        width: 0%;
        transition: width 1s ease-in-out;
    }

    /* Стили для калькулятора прибыли */
    .calculator-title {
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.4rem;
        color: var(--accent-primary);
        text-shadow: 0 0 8px var(--accent-primary-glow);
    }
    
    .calculation-header {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--text-primary);
    }
    
    .sell-price-result {
        font-size: 1.5rem;
        margin: 15px 0;
        text-align: center;
        font-weight: bold;
        color: var(--text-primary);
    }
    
    .price-highlight {
        color: var(--accent-primary);
        text-shadow: 0 0 5px var(--accent-primary-glow);
    }
    
    .calculation-details {
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .calculation-details div {
        margin: 5px 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .action-buttons {
        position: fixed;
        bottom: var(--spacing-xl);
        right: var(--spacing-xl);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        z-index: 100;
    }

    .add-btn {
        position: relative;
        bottom: auto;
        right: auto;
    }

    .myskins-btn {
        width: 64px;
        height: 64px;
        border-radius: var(--radius-full);
        background: var(--gradient-primary);
        color: white;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition-normal);
        border: none;
        box-shadow: 
            var(--shadow-lg), 
            0 0 20px var(--accent-primary-glow);
        overflow: hidden;
        position: relative;
    }

    .myskins-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--gradient-secondary);
        opacity: 0;
        transition: opacity 0.5s ease;
    }

    .myskins-btn:hover::before {
        opacity: 1;
    }

    .myskins-btn:hover {
        transform: scale(1.1);
        box-shadow: 
            var(--shadow-lg), 
            0 0 30px var(--accent-primary-glow);
    }

    .myskins-btn span {
        position: relative;
        z-index: 1;
    }

    /* Стили для списка скинов */
    .my-skins-list {
        margin-top: var(--spacing-md);
        max-height: 400px;
        overflow-y: auto;
    }

    .skin-item {
        background: var(--bg-card);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        border: 1px solid var(--border);
        transition: var(--transition-normal);
        position: relative;
    }

    .skin-item:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .skin-item h3 {
        margin: 0 0 var(--spacing-sm) 0;
        font-size: 1.1rem;
        color: var(--text-primary);
    }

    .skin-item p {
        margin: var(--spacing-xs) 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .skin-item .skin-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
    }

    .skin-item .skin-actions button {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.85rem;
    }

    .info-box {
        background: rgba(79, 70, 229, 0.1);
        border-left: 4px solid var(--accent-primary);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        border-radius: var(--radius-md);
        position: relative;
    }

    .info-box p {
        margin: var(--spacing-xs) 0;
        color: var(--text-secondary);
    }

    .info-box button {
        margin-top: var(--spacing-sm);
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.8rem;
    }

    .calculation-result {
        background: var(--bg-input);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
        border: 1px solid var(--border);
    }

    .info-toggle {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        color: var(--accent-primary);
        font-size: 0.9rem;
        margin-bottom: var(--spacing-md);
        transition: var(--transition-normal);
        width: fit-content;
    }
    
    .info-toggle:hover {
        color: var(--accent-primary-hover);
        text-decoration: underline;
    }
    
    .info-toggle i {
        font-size: 1rem;
    }

    /* Стили для розовой темы */
    .pink-theme .confirm-buttons .btn-primary {
        background: linear-gradient(135deg, #ff69b4, #ff1493);
        box-shadow: 0 2px 10px rgba(255, 105, 180, 0.6);
    }
    
    .pink-theme .confirm-buttons .btn-secondary {
        background: #3d1d47;
        color: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 105, 180, 0.3);
    }
    
    .pink-theme .confirm-buttons .btn-secondary:hover {
        background: #2d1535;
        border: 1px solid rgba(255, 105, 180, 0.5);
    }
    
    .pink-theme .btn-primary {
        background: linear-gradient(135deg, #ff69b4, #ff1493);
        box-shadow: 0 0 10px rgba(255, 105, 180, 0.6);
    }
    
    .pink-theme .btn-primary:hover {
        box-shadow: 0 0 15px rgba(255, 105, 180, 0.6);
    }
    
    .pink-theme .btn-danger {
        background: linear-gradient(135deg, #ff69b4, #ff1493);
    }

    .transaction-card .transaction-actions {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-top: auto;
        gap: var(--spacing-md);
    }

    .transaction-card .btn-icon {
        width: 44px;
        height: 44px;
        font-size: 1.2rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        transition: all 0.3s ease;
        border-radius: 50%;
        margin-left: 5px;
    }

    .transaction-card .btn-icon:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
        background: var(--glass-hover);
    }

    .transaction-card .btn-icon svg {
        transition: all 0.3s ease;
        width: 22px;
        height: 22px;
    }

    .transaction-card .btn-icon:hover svg {
        stroke: var(--accent-primary);
    }

    /* Стили для отображения информации о скине */
    .skin-info {
        display: flex;
        flex-direction: column;
        margin-bottom: 5px;
    }
    
    .skin-weapon {
        font-size: 0.85rem;
        color: var(--text-tertiary);
        margin-bottom: 2px;
    }
    
    .skin-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
    }
    
    .skin-quality {
        font-size: 0.8rem;
        color: var(--accent-primary);
        margin-bottom: 5px;
    }

    /* Качества скинов */
    .quality-fn {
        color: #66eb73; /* Factory New */
    }
    
    .quality-mw {
        color: #4b84ff; /* Minimal Wear */
    }
    
    .quality-ft {
        color: #7f59fe; /* Field-Tested */
    }
    
    .quality-ww {
        color: #e25a00; /* Well-Worn */
    }
    
    .quality-bs {
        color: #eb4b4b; /* Battle-Scarred */
    }

    /**
     * Парсит название скина на составляющие: оружие, название скина и качество
     * @param {string} fullSkinName - Полное название скина
     * @return {Object} Объект с полями weapon, name, quality
     */
    function parseSkinName(fullSkinName) {
    // Результат по умолчанию
    let result = {
        weapon: '',
        name: fullSkinName,
        quality: '',
        qualityClass: ''
    };

    // Качества скинов и соответствующие CSS классы
    const qualities = [
        { text: 'Factory New', shortText: 'FN', class: 'quality-fn' },
        { text: 'Minimal Wear', shortText: 'MW', class: 'quality-mw' },
        { text: 'Field-Tested', shortText: 'FT', class: 'quality-ft' },
        { text: 'Well-Worn', shortText: 'WW', class: 'quality-ww' },
        { text: 'Battle-Scarred', shortText: 'BS', class: 'quality-bs' }
    ];

    // Поиск качества
    for (const quality of qualities) {
        if (
            fullSkinName.includes(quality.text) ||
            fullSkinName.includes(`(${quality.shortText})`) ||
            fullSkinName.includes(quality.shortText)
        ) {
            result.quality = quality.text;
            result.qualityClass = quality.class;
            break;
        }
    }

    // Удаление всех форматов обозначения качества
    if (result.quality) {
        const patternsToRemove = [
            result.quality,
            `(${result.quality})`,
            qualities.find(q => q.text === result.quality)?.shortText || '',
            `(${qualities.find(q => q.text === result.quality)?.shortText || ''})`
        ];

        for (const pattern of patternsToRemove) {
            if (pattern) {
                fullSkinName = fullSkinName.replace(pattern, '').trim();
            }
        }

        fullSkinName = fullSkinName.replace(/\(\s*\)/g, '').trim();
    }

    // Разделение на оружие и имя скина (если есть разделитель "|")
    if (fullSkinName.includes('|')) {
        const parts = fullSkinName.split('|').map(part => part.trim());
        result.weapon = parts[0];
        result.name = parts[1];
    } else {
        // Если разделителя нет, пробуем определить по известным оружиям
        const weapons = [
            'AK-47', 'M4A4', 'M4A1-S', 'AWP', 'Desert Eagle', 'USP-S', 'P250', 'Glock-18',
            'Five-SeveN', 'P90', 'MP5-SD', 'MP7', 'MP9', 'MAC-10', 'UMP-45', 'PP-Bizon',
            'Galil AR', 'FAMAS', 'SG 553', 'AUG', 'SSG 08', 'G3SG1', 'SCAR-20'
        ];

        for (const weapon of weapons) {
            if (fullSkinName.startsWith(weapon)) {
                result.weapon = weapon;
                result.name = fullSkinName.substring(weapon.length).trim();
                break;
            }
        }

        if (!result.weapon) {
            result.name = fullSkinName.trim();
        }
    }

    return result;
}
</style>
</head>
<body>
    <div class="glow-cursor"></div>

    <div class="theme-toggle" onclick="toggleTheme()">
        <svg viewBox="0 0 24 24" id="theme-icon">
            <path id="moon" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            <circle id="sun" cx="12" cy="12" r="5" style="display:none;"/>
            <line id="sun-ray-1" x1="12" y1="1" x2="12" y2="3" style="display:none;"/>
            <line id="sun-ray-2" x1="12" y1="21" x2="12" y2="23" style="display:none;"/>
            <line id="sun-ray-3" x1="4.22" y1="4.22" x2="5.64" y2="5.64" style="display:none;"/>
            <line id="sun-ray-4" x1="18.36" y1="18.36" x2="19.78" y2="19.78" style="display:none;"/>
            <line id="sun-ray-5" x1="1" y1="12" x2="3" y2="12" style="display:none;"/>
            <line id="sun-ray-6" x1="21" y1="12" x2="23" y2="12" style="display:none;"/>
            <line id="sun-ray-7" x1="4.22" y1="19.78" x2="5.64" y2="18.36" style="display:none;"/>
            <line id="sun-ray-8" x1="18.36" y1="5.64" x2="19.78" y2="4.22" style="display:none;"/>
            <path id="heart" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" style="display:none;"/>
        </svg>
    </div>

    <div class="theme-menu" id="theme-menu">
        <div class="theme-option" data-theme="dark">
            <div class="theme-icon">
                <ion-icon name="moon-outline"></ion-icon>
            </div>
            <span>Темная тема</span>
        </div>
        <div class="theme-option" data-theme="light">
            <div class="theme-icon">
                <ion-icon name="sunny-outline"></ion-icon>
            </div>
            <span>Светлая тема</span>
        </div>
        <div class="theme-option" data-theme="pink">
            <div class="theme-icon">
                <ion-icon name="flower-outline"></ion-icon>
            </div>
            <span>Розовая тема</span>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-icon-wrapper">
            <div class="nav-icon" onclick="window.location.href='index.html'">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <div class="nav-tooltip">Главная</div>
        </div>
        <div class="nav-icon-wrapper">
            <div class="nav-icon" onclick="exportTransactions()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </div>
            <div class="nav-tooltip">Экспорт</div>
        </div>
        <div class="nav-icon-wrapper">
            <div class="nav-icon" onclick="document.getElementById('fileInput').click()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
            </div>
            <div class="nav-tooltip">Импорт</div>
        </div>
    </div>

    <div class="dashboard">
    <div class="card balance-card float-animation">
        <div class="card-glow"></div>
        <h3>Общий баланс</h3>
        <h1 id="totalBalance" class="pulse-animation">$0</h1>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="changePeriod('day')">День</button>
            <button class="btn btn-secondary" onclick="changePeriod('week')">Неделя</button>
            <button class="btn btn-secondary" onclick="changePeriod('month')">Месяц</button>
            <button class="btn btn-secondary btn-active" onclick="changePeriod('all')">Все</button>
        </div>
        <button class="btn btn-primary btn-large" onclick="openStatsModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
            Показать статистику
        </button>
        <div class="telegram-buttons">
            <a href="https://t.me/+BwTh8OyJmC0wN2Vi" target="_blank" class="telegram-button" rel="noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                <span>Telegram 1</span>
            </a>
            <a href="https://t.me/+UxvIvNPO4-kxMmI6" target="_blank" class="telegram-button" rel="noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                <span>Telegram 2</span>
            </a>
        </div>
    </div>

    <div class="profit-loss">
        <div class="card profit-loss-card income">
            <div class="card-glow"></div>
            <h3>Общий доход</h3>
            <h2 id="totalIncome">$0</h2>
        </div>
        <div class="card profit-loss-card expense">
            <div class="card-glow"></div>
            <h3>Общий расход</h3>
            <h2 id="totalExpense">$0</h2>
        </div>
    </div>

    <div class="card chart-container">
        <div class="card-glow"></div>
        <div class="chart-glow"></div>
        <canvas id="mainChart"></canvas>
    </div>
    <button class="switch-view right" onclick="switchToCalendar()">
        <span>❯</span>
    </button>

    <div class="card calendar-container">
        <div class="card-glow"></div>
        <div class="calendar-nav">
            <button class="btn btn-secondary" onclick="changeMonth(-1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <h2 id="currentMonth"></h2>
            <button class="btn btn-secondary" onclick="changeMonth(1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    <button class="switch-view left" onclick="switchToChart()">
        <span>❮</span>
    </button>

    <div class="search-container">
        <input type="date" id="searchDate" class="search-input" onchange="filterTransactions()" placeholder="Поиск по дате">
        <input type="text" id="searchName" class="search-input" onkeyup="filterTransactions()" placeholder="Поиск по названию">
        <input type="number" id="searchAmount" class="search-input" onkeyup="filterTransactions()" placeholder="Поиск по сумме">
        <select id="sortOrder" class="search-input" onchange="filterTransactions()">
            <option value="newest">Сначала новые</option>
            <option value="oldest">Сначала старые</option>
            <option value="highest">Высокая сумма</option>
            <option value="lowest">Низкая сумма</option>
            <option value="profitable">Прибыльные сделки</option>
            <option value="unprofitable">Убыточные сделки</option>
        </select>
        <button id="viewToggleBtn" class="view-toggle-btn active" onclick="toggleTransactionsView()">
            <i class="fas fa-list"></i> Список
        </button>
    </div>

    <div class="transactions-list" id="transactions"></div>
    <div class="transactions-grid" id="transactionsGrid" style="display: none;"></div>

    <div class="action-buttons">
    <button class="add-btn" onclick="openModal()">
        <span>+</span>
    </button>
        <button class="myskins-btn" onclick="openMySkinsModal()" title="Мои скины">
            <span><i class="fas fa-cubes"></i></span>
    </button>
    </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Добавить транзакцию</h2>
            <span class="close" onclick="closeModalWithConfirmation()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="transactionType">Тип транзакции</label>
                <select id="transactionType" class="form-control" onchange="toggleTransactionFields()">
                    <option value="simple">Простая транзакция</option>
                    <option value="advanced">Расширенная сделка</option>
                    <option value="calculator">Калькулятор прибыли</option>
                </select>
            </div>
            
            <div id="simpleTransactionFields">
                <div class="form-group">
                    <label for="type">Категория</label>
                    <select id="type" class="form-control">
                        <option value="income">Доход</option>
                        <option value="expense">Расход</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount">Сумма</label>
                    <input type="number" id="amount" placeholder="Введите сумму" class="form-control">
                </div>
                <div class="form-group">
                    <label for="date">Дата</label>
                    <input type="date" id="date" class="form-control">
                </div>
                <div class="form-group">
                    <label for="description">Описание</label>
                    <textarea id="description" placeholder="Введите описание" class="form-control"></textarea>
                </div>
            </div>
            
            <div id="advancedTransactionFields" style="display:none;">
                <div class="form-group">
                    <label for="skinName">Название скина</label>
                    <input type="text" id="skinName" placeholder="Введите название скина" class="form-control">
                </div>
                <div class="form-group">
                    <label for="skinQuality">Качество скина</label>
                    <select id="skinQuality" class="form-control">
                        <option value="">Не выбрано</option>
                        <option value="Factory New">Прямо с завода (Factory New)</option>
                        <option value="Minimal Wear">Немного поношенный (Minimal Wear)</option>
                        <option value="Field-Tested">После полевых испытаний (Field-Tested)</option>
                        <option value="Well-Worn">Поношенный (Well-Worn)</option>
                        <option value="Battle-Scarred">Закаленный в боях (Battle-Scarred)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="skinType">Тип скина</label>
                    <select id="skinType" class="form-control">
                        <option value="Normal">Normal</option>
                        <option value="StatTrak">StatTrak</option>
                        <option value="Souvenir">Souvenir</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="buyPrice">Цена покупки ($)</label>
                    <input type="number" id="buyPrice" placeholder="Введите цену покупки" class="form-control">
                </div>
                <div class="form-group">
                    <label for="sellPrice">Цена продажи ($)</label>
                    <input type="number" id="sellPrice" placeholder="Введите цену продажи" class="form-control">
                </div>
                <div class="form-group">
                    <label for="profitPercentage">Комиссия</label>
                    <select id="profitPercentage" class="form-control">
                        <option value="2">2%</option>
                        <option value="2.5">2.5%</option>
                        <option value="5">5%</option>
                        <option value="10">10%</option>
                        <option value="13">13%</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="advancedDate">Дата</label>
                    <input type="date" id="advancedDate" class="form-control">
                </div>
                <button onclick="calculateProfit()" class="btn btn-secondary btn-large">Рассчитать</button>
                <div id="calculationResult" class="calculation-result" style="display:none;"></div>
            </div>
            
            <div id="calculatorFields" style="display:none;">
                <div class="form-group">
                    <label for="calcBuyPrice">Цена покупки ($):</label>
                    <input type="number" id="calcBuyPrice" placeholder="Введите цену покупки" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="calcDesiredProfit">Желаемая прибыль ($):</label>
                    <input type="number" id="calcDesiredProfit" placeholder="Введите желаемую прибыль" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="calcCommission">Комиссия (%):</label>
                    <input type="number" id="calcCommission" placeholder="Комиссия в процентах" class="form-control" value="2" step="0.1">
                </div>
                <button onclick="calculateSellPrice()" class="btn btn-secondary btn-large">Рассчитать цену продажи</button>
                <div id="sellPriceResult" class="calculation-result" style="display:none; margin-top: 20px;"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal()" class="btn btn-secondary">Отмена</button>
            <button onclick="addTransaction()" id="addTransactionBtn" class="btn btn-primary">Добавить</button>
            <button onclick="addAdvancedTransaction()" id="addAdvancedTransactionBtn" class="btn btn-primary" style="display:none;">Добавить сделку</button>
        </div>
    </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
    <div class="confirm-modal-content">
        <p>Выйти без изменений?</p>
        <div class="confirm-buttons">
            <button onclick="confirmCloseModal(true)" class="btn btn-primary">Да</button>
            <button onclick="confirmCloseModal(false)" class="btn btn-secondary">Нет</button>
        </div>
    </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Статистика</h2>
            <span class="close" onclick="closeStatsModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="stats-grid">
                <div class="stats-item">
                    <h3>Сегодня</h3>
                    <p id="todayEarnings">$0</p>
                    <small id="todayDeals">0 сделок</small>
                </div>
                <div class="stats-item">
                    <h3>Вчера</h3>
                    <p id="yesterdayEarnings">$0</p>
                    <small id="yesterdayDeals">0 сделок</small>
                </div>
                <div class="stats-item">
                    <h3>Последние 7 дней</h3>
                    <p id="weekEarnings">$0</p>
                    <small id="weekDeals">0 сделок</small>
                </div>
                <div class="stats-item">
                    <h3>Последние 30 дней</h3>
                    <p id="monthEarnings">$0</p>
                    <small id="monthDeals">0 сделок</small>
                </div>
                <div class="stats-item" style="grid-column: span 2;">
                    <h3>Итого за всё время</h3>
                    <p id="totalEarnings">$0</p>
                    <small id="totalDeals">0 сделок</small>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeStatsModal()" class="btn btn-primary">Закрыть</button>
        </div>
    </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" style="display:none" onchange="importTransactions(event)">
    
    <!-- Модальное окно подтверждения удаления -->
    <div id="deleteConfirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <h3>Подтвердите действие</h3>
            <p>Вы уверены, что хотите удалить эту транзакцию?</p>
            <div class="confirm-buttons">
                <button id="deleteConfirmButton" class="btn btn-primary">OK</button>
                <button onclick="closeDeleteConfirmModal()" class="btn btn-secondary">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно "Мои скины" -->
    <div id="mySkinsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Мои скины</h2>
                <span class="close" onclick="closeMySkinsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="mySkinsInfo" class="info-box">
                    <p>Здесь вы можете сохранять скины, которые купили, но ещё не продали. Когда продадите — просто добавьте цену продажи, и скин попадёт в статистику.</p>
                    <p>Важно: все данные хранятся локально в вашем браузере. Если вы очистите кэш, куки или переустановите браузер — информация может быть утеряна!</p>
                    <button class="btn btn-secondary btn-small" onclick="toggleMySkinsInfo()">Скрыть</button>
                </div>
                <div class="info-toggle" onclick="toggleMySkinsInfo()" style="display: none;">
                    <i class="fas fa-info-circle"></i> Показать информацию
                </div>
                <div class="form-group">
                    <button onclick="openAddSkinModal()" class="btn btn-primary">Добавить скин</button>
                </div>
                <div id="mySkinsListContainer" class="my-skins-list">
                    <div id="mySkinsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления скина -->
    <div id="addSkinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addSkinModalTitle">Добавить скин</h2>
                <span class="close" onclick="closeAddSkinModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newSkinName">Название скина</label>
                    <input type="text" id="newSkinName" placeholder="Введите название скина" class="form-control">
                </div>
                <div class="form-group">
                    <label for="newSkinBuyPrice">Цена покупки ($)</label>
                    <input type="number" id="newSkinBuyPrice" placeholder="Введите цену покупки" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="newSkinDate">Дата покупки</label>
                    <input type="date" id="newSkinDate" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddSkinModal()" class="btn btn-secondary">Отмена</button>
                <button onclick="saveSkin()" id="saveSkinBtn" class="btn btn-primary">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления продажи -->
    <div id="addSaleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Добавить продажу</h2>
                <span class="close" onclick="closeAddSaleModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="saleModalSkinName">Название скина:</label>
                    <input type="text" id="saleModalSkinName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="saleModalBuyPrice">Цена покупки ($):</label>
                    <input type="number" id="saleModalBuyPrice" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="saleModalSellPrice">Цена продажи ($):</label>
                    <input type="number" id="saleModalSellPrice" placeholder="Введите цену продажи" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="saleModalCommission">Комиссия:</label>
                    <select id="saleModalCommission" class="form-control">
                        <option value="2">2%</option>
                        <option value="2.5">2.5%</option>
                        <option value="5">5%</option>
                        <option value="10">10%</option>
                        <option value="13">13%</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="saleModalDate">Дата продажи:</label>
                    <input type="date" id="saleModalDate" class="form-control">
                </div>
                <button onclick="calculateSaleProfit()" class="btn btn-secondary btn-large">Рассчитать прибыль</button>
                <div id="saleCalculationResult" class="calculation-result" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddSaleModal()" class="btn btn-secondary">Отмена</button>
                <button onclick="saveSale()" id="saveSaleBtn" class="btn btn-primary">Добавить сделку</button>
            </div>
        </div>
    </div>

    <script>
        // Инициализация графика
        let chart;
        let currentView = 'chart';
        let currentTheme = localStorage.getItem('theme') || 'dark-theme';
        document.documentElement.classList.add(currentTheme);

        // Функция для переключения темы
        function toggleTheme() {
            const root = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            const moon = document.getElementById('moon');
            const sun = document.getElementById('sun');
            const heart = document.getElementById('heart');
            const sunRays = Array.from({ length: 8 }, (_, i) => document.getElementById(`sun-ray-${i + 1}`));

            if (root.classList.contains('dark-theme')) {
                root.classList.remove('dark-theme');
                root.classList.add('light-theme');
                moon.style.display = 'none';
                sun.style.display = 'block';
                sunRays.forEach(ray => ray.style.display = 'block');
                heart.style.display = 'none';
                localStorage.setItem('theme', 'light-theme');
            } else if (root.classList.contains('light-theme')) {
                root.classList.remove('light-theme');
                root.classList.add('pink-theme');
                sun.style.display = 'none';
                sunRays.forEach(ray => ray.style.display = 'none');
                heart.style.display = 'block';
                localStorage.setItem('theme', 'pink-theme');
            } else {
                root.classList.remove('pink-theme');
                root.classList.add('dark-theme');
                heart.style.display = 'none';
                moon.style.display = 'block';
                localStorage.setItem('theme', 'dark-theme');
            }

            // Добавляем эффект перехода
            const transition = document.createElement('div');
            transition.className = 'theme-transition';
            document.body.appendChild(transition);
            
            requestAnimationFrame(() => {
                transition.style.opacity = '1';
                setTimeout(() => {
                    transition.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(transition);
                    }, 300);
                }, 50);
            });
        }

        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let currentPeriod = 'all';
        let lastCalculatedProfit = 0;
        let currentDate = new Date();
        let editingTransactionIndex = null;
        let currentDeletingIndex = null;
        let hasChanges = false;
        let sparkles = [];

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(79, 70, 229, 0.3)');
            gradient.addColorStop(0.5, 'rgba(139, 92, 246, 0.15)');
            gradient.addColorStop(1, 'rgba(236, 72, 153, 0.05)');

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Баланс',
                        data: [],
                        borderColor: '#4f46e5',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        backgroundColor: gradient,
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#4f46e5',
                        pointHoverBackgroundColor: '#4f46e5',
                        pointBorderColor: 'white',
                        pointHoverBorderColor: 'white',
                        pointBorderWidth: 2,
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString();
                                }
                            },
                            animation: {
                                duration: 400,
                                easing: 'easeOutQuart'
                            }
                        }
                    },
                    scales: {
                        x: { 
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.5)',
                                font: {
                                    size: 10
                                },
                                maxRotation: 0
                            }
                        },
                        y: { 
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.5)',
                                callback: value => '$' + value.toLocaleString(),
                                font: {
                                    size: 10
                                }
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    elements: {
                        line: {
                            borderJoinStyle: 'round'
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function updateBalance() {
            const filteredTransactions = filterTransactionsByPeriod(transactions, currentPeriod);
            let balance = 0;
            
            filteredTransactions.forEach(t => {
                balance = t.type === 'income' ? balance + t.amount : balance - t.amount;
            });
            
            // Animate the balance change
            const balanceElement = document.getElementById('totalBalance');
            const currentBalanceText = balanceElement.textContent;
            const currentBalanceValue = parseFloat(currentBalanceText.replace(/[^0-9.-]+/g, '')) || 0;
            
            animateValue(balanceElement, currentBalanceValue, balance, 1000, '$');
        }

        function animateValue(element, start, end, duration, prefix = '', suffix = '') {
            const startTime = performance.now();
            const updateAnimation = (currentTime) => {
                const elapsedTime = currentTime - startTime;
                const progress = Math.min(elapsedTime / duration, 1);
                const easedProgress = easeOutQuart(progress);
                const value = start + (end - start) * easedProgress;
                
                element.textContent = `${prefix}${value.toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                })}${suffix}`;
                
                if (progress < 1) {
                    requestAnimationFrame(updateAnimation);
                } else {
                    // Create sparkles around the element when animation completes
                    if (Math.abs(end - start) > 10) {
                        createSparklesAround(element, 10);
                    }
                }
            };
            
            requestAnimationFrame(updateAnimation);
        }

        function easeOutQuart(x) {
            return 1 - Math.pow(1 - x, 4);
        }

        function renderTransactions() {
            const container = document.getElementById('transactions');
            
            container.innerHTML = transactions.map((t, i) => {
                // Показываем проценты только если есть данные о покупке и продаже
                const showPercent = t.buyPrice && t.sellPrice && t.profitPercent;
                
                return `
                <div class="transaction-item" data-index="${i}">
                    <div class="transaction-info">
                        <h4>${t.description}</h4>
                        <small>${new Date(t.date).toLocaleDateString()}</small>
                    </div>
                    <div class="transaction-actions">
                        <span class="transaction-amount ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString()}
                            ${showPercent ? `<span class="profit-percent">(${t.type === 'income' ? '+' : '-'}${t.profitPercent}%)</span>` : ''}
                        </span>
                        <button onclick="editTransaction(${i})" class="btn btn-secondary btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button onclick="confirmDelete(${i})" class="btn btn-secondary btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');

            // Add animation delay to each transaction item
            const items = document.querySelectorAll('.transaction-item');
            items.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.05}s`;
                
                // Add hover effect listeners for sparkles
                item.addEventListener('mouseenter', function() {
                    createSparklesAround(this, 5);
                });
            });
        }

        function addTransaction() {
            const amount = parseFloat(document.getElementById('amount').value);
            if (isNaN(amount) || amount <= 0) return alert('Введите корректную сумму');

            const transaction = {
                type: document.getElementById('type').value,
                amount: amount,
                description: document.getElementById('description').value || 'Без описания',
                date: document.getElementById('date').value || new Date().toISOString().split('T')[0]
                // Убираем стандартные проценты, пусть определяются только там, где они рассчитаны
            };
            
            if (editingTransactionIndex !== null) {
                transactions[editingTransactionIndex] = transaction;
            } else {
                transactions.push(transaction);
            }
            
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI();
            closeModal();
            
            // Create sparkles effect
            createSparklesAround(document.querySelector('.add-btn'), 15);
            
            // Show success notification
            showNotification('Транзакция успешно добавлена', 'success');
        }

        function calculateProfit() {
            const skinName = document.getElementById('skinName').value;
            const skinQuality = document.getElementById('skinQuality').value;
            const skinType = document.getElementById('skinType').value;
            const buy = parseFloat(document.getElementById('buyPrice').value);
            const sell = parseFloat(document.getElementById('sellPrice').value);
            const percent = parseFloat(document.getElementById('profitPercentage').value);
            
            if (!skinName || isNaN(buy) || isNaN(sell)) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            // Формируем полное название скина с учетом типа и качества
            let fullSkinName = skinName;
            
            // Добавляем StatTrak или Souvenir в начало, если выбрано
            if (skinType && skinType !== 'Normal') {
                fullSkinName = `${skinType} ${fullSkinName}`;
            }
            
            // Добавляем качество в конец, если выбрано
            if (skinQuality) {
                fullSkinName = `${fullSkinName} (${skinQuality})`;
            }
            
            const fee = sell * (percent / 100);
            const profit = sell - buy - fee;
            lastCalculatedProfit = profit;

            const resultHTML = `
                <p><strong>Тема:</strong> ${fullSkinName}</p>
                <p><strong>Цена покупки:</strong> $${buy.toLocaleString()}</p>
                <p><strong>Цена продажи:</strong> $${sell.toLocaleString()}</p>
                <p><strong>Комиссия:</strong> $${fee.toLocaleString()} (${percent}%)</p>
                <p><strong>Прибыль:</strong> <span class="${profit >= 0 ? 'positive-balance' : 'negative-balance'}">$${profit.toLocaleString()}</span></p>
            `;
            
            const resultElement = document.getElementById('calculationResult');
            resultElement.innerHTML = resultHTML;
            resultElement.style.display = 'block';
            
            // Улучшенная анимация появления результата
            gsap.fromTo(resultElement, 
                { y: -20, opacity: 0, scale: 0.95 },
                { y: 0, opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)" }
            );
            
            // Добавляем эффект свечения вокруг результата
            gsap.to(resultElement, {
                boxShadow: '0 0 20px var(--accent-primary-glow)',
                duration: 0.5
            });
            
            document.getElementById('addAdvancedTransactionBtn').style.display = 'block';
            document.getElementById('addTransactionBtn').style.display = 'none';
            hasChanges = true;
            
            // Create sparkles effect
            createSparklesAround(resultElement, 15);
            
            // Прокручиваем к результату, чтобы он был виден
            resultElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function calculateSellPrice() {
            const buyPrice = parseFloat(document.getElementById('calcBuyPrice').value);
            const desiredProfit = parseFloat(document.getElementById('calcDesiredProfit').value);
            const commission = parseFloat(document.getElementById('calcCommission').value);
            
            if (isNaN(buyPrice) || isNaN(desiredProfit) || isNaN(commission)) {
                alert('Пожалуйста, заполните все поля корректными числовыми значениями');
                return;
            }
            
            // Формула: sellPrice = (buyPrice + desiredProfit) / (1 - commission/100)
            const sellPrice = (buyPrice + desiredProfit) / (1 - commission/100);
            
            const resultHTML = `
                <div class="calculation-header">Результат расчета:</div>
                <div class="sell-price-result">Нужно продать за: <span class="price-highlight">$${sellPrice.toFixed(2)}</span></div>
                <div class="calculation-details">
                    <div>Цена покупки: $${buyPrice.toFixed(2)}</div>
                    <div>Желаемая прибыль: $${desiredProfit.toFixed(2)}</div>
                    <div>Комиссия: ${commission}%</div>
                </div>
            `;
            
            const resultElement = document.getElementById('sellPriceResult');
            resultElement.innerHTML = resultHTML;
            resultElement.style.display = 'block';
            
            // Анимация появления результата
            gsap.fromTo(resultElement, 
                { y: -20, opacity: 0, scale: 0.95 },
                { y: 0, opacity: 1, scale: 1, duration: 0.5, ease: "back.out(1.7)" }
            );
            
            // Добавляем эффект свечения вокруг результата
            gsap.to(resultElement, {
                boxShadow: '0 0 20px var(--accent-primary-glow)',
                duration: 0.5
            });
            
            // Create sparkles effect
            createSparklesAround(resultElement, 15);
            
            // Прокручиваем к результату, чтобы он был виден
            resultElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function addAdvancedTransaction() {
            // Если прибыль еще не рассчитана или равна 0, автоматически вызываем расчет
            if (lastCalculatedProfit === undefined || lastCalculatedProfit === 0) {
                calculateProfit();
            }

            // Если после автоматического расчета прибыль все еще равна 0, запросим подтверждение
            if (lastCalculatedProfit === 0 && !confirm('Прибыль равна 0. Вы уверены, что хотите добавить эту сделку?')) {
                return;
            }

            const skinName = document.getElementById('skinName').value;
            const skinQuality = document.getElementById('skinQuality').value;
            const skinType = document.getElementById('skinType').value;
            const buyPrice = parseFloat(document.getElementById('buyPrice').value);
            const sellPrice = parseFloat(document.getElementById('sellPrice').value);
            const percent = parseFloat(document.getElementById('profitPercentage').value);
            const date = document.getElementById('advancedDate').value || new Date().toISOString().split('T')[0];
            const profitPercent = ((lastCalculatedProfit / buyPrice) * 100).toFixed(2);
            
            // Формируем полное название скина с учетом типа и качества
            let fullSkinName = skinName;
            
            // Добавляем StatTrak или Souvenir в начало, если выбрано
            if (skinType && skinType !== 'Normal') {
                fullSkinName = `${skinType} ${fullSkinName}`;
            }
            
            // Добавляем качество в конец, если выбрано
            if (skinQuality) {
                fullSkinName = `${fullSkinName} (${skinQuality})`;
            }

            const transaction = {
                type: lastCalculatedProfit >= 0 ? 'income' : 'expense',
                amount: Math.abs(lastCalculatedProfit),
                description: `${fullSkinName} (${lastCalculatedProfit >= 0 ? 'прибыль' : 'убыток'}: $${Math.abs(lastCalculatedProfit).toLocaleString()})`,
                date: date,
                theme: fullSkinName,
                buyPrice: buyPrice,
                sellPrice: sellPrice,
                commission: percent,
                profitPercent: Math.abs(profitPercent),
                skinQuality: skinQuality,
                skinType: skinType
            };

            if (editingTransactionIndex !== null) {
                transactions[editingTransactionIndex] = transaction;
            } else {
                transactions.push(transaction);
            }

            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI();
            closeModal();
            
            // Create sparkles effect
            createSparklesAround(document.querySelector('.add-btn'), 15);
            
            // Show success notification
            showNotification('Сделка успешно добавлена', 'success');
        }

        function exportTransactions() {
            const data = JSON.stringify(transactions, null, 2);
            const blob = new Blob([data], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transactions.json';
            a.click();
            
            // Create sparkles effect
            createSparklesAround(document.querySelector('.nav-icon:nth-child(3)'), 10);
            
            // Show success notification
            showNotification('Данные успешно экспортированы', 'success');
        }

        function importTransactions(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                try {
                    const jsonData = JSON.parse(content);
                    transactions = jsonData;
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    updateUI();
                    
                    // Create sparkles effect
                    createSparklesAround(document.querySelector('.nav-icon:nth-child(4)'), 15);
                    
                    // Show success message with animation
                    showNotification('Данные успешно импортированы', 'success');
                } catch (error) {
                    try {
                        const lines = content.split('\n');
                        const newTransactions = [];
                        let currentTransaction = {};

                        lines.forEach(line => {
                            const [key, value] = line.split(': ').map(item => item.trim());
                            if (key === 'Тип') {
                                if (Object.keys(currentTransaction).length > 0) {
                                    newTransactions.push(currentTransaction);
                                    currentTransaction = {};
                                }
                                currentTransaction.type = value;
                            } else if (key === 'Сумма') {
                                currentTransaction.amount = Number.parseFloat(value);
                            } else if (key ==='Описание') {
                                currentTransaction.description = value;
                            } else if (key === 'Дата') {
                                currentTransaction.date = value;
                            } else if (key === 'Тема') {
                                currentTransaction.theme = value;
                            } else if (key === 'Цена покупки') {
                                currentTransaction.buyPrice = Number.parseFloat(value) || null;
                            } else if (key === 'Цена продажи') {
                                currentTransaction.sellPrice = Number.parseFloat(value) || null;
                            } else if (key === 'Комиссия') {
                                currentTransaction.commission = Number.parseFloat(value) || null;
                            }
                        });

                        if (Object.keys(currentTransaction).length > 0) {
                            newTransactions.push(currentTransaction);
                        }

                        transactions = transactions.concat(newTransactions);
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        updateUI();
                        
                        // Create sparkles effect
                        createSparklesAround(document.querySelector('.nav-icon:nth-child(4)'), 15);
                        
                        // Show success message with animation
                        showNotification('Данные успешно импортированы', 'success');
                    } catch (e) {
                        showNotification('Ошибка при импорте данных', 'error');
                    }
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(-50%) translateY(-10px)';
            }, 10);
            
            // Animate out and remove
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(10px)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        function updateProfitLoss() {
            const filteredTransactions = filterTransactionsByPeriod(transactions, currentPeriod);
            let income = 0;
            let expense = 0;
            
            filteredTransactions.forEach(t => {
                if (t.type === 'income') {
                    income += t.amount;
                } else {
                    expense += t.amount;
                }
            });
            
            // Animate the income and expense changes
            const incomeElement = document.getElementById('totalIncome');
            const expenseElement = document.getElementById('totalExpense');
            
            const currentIncome = parseFloat(incomeElement.textContent.replace(/[^0-9.-]+/g, '')) || 0;
            const currentExpense = parseFloat(expenseElement.textContent.replace(/[^0-9.-]+/g, '')) || 0;
            
            animateValue(incomeElement, currentIncome, income, 1000, '$');
            animateValue(expenseElement, currentExpense, expense, 1000, '$');
        }

        function editTransaction(index) {
            editingTransactionIndex = index;
            const t = transactions[index];
            document.getElementById('transactionType').value = t.theme ? 'advanced' : 'simple';
            toggleTransactionFields();
            
            if (t.theme) {
                // Парсим информацию о скине, если она доступна
                let skinName = t.theme;
                let skinType = t.skinType || 'Normal';
                let skinQuality = t.skinQuality || '';
                
                // Если в записи сохранены отдельные поля для типа и качества, используем их
                if (!t.skinType || !t.skinQuality) {
                    // Пытаемся распарсить из названия скина
                    // Сначала проверяем на StatTrak или Souvenir
                    if (skinName.startsWith('StatTrak ')) {
                        skinType = 'StatTrak';
                        skinName = skinName.substring(9).trim();
                    } else if (skinName.startsWith('Souvenir ')) {
                        skinType = 'Souvenir';
                        skinName = skinName.substring(9).trim();
                    }
                    
                    // Проверяем на наличие информации о качестве в скобках
                    const qualityMatch = skinName.match(/\(([^)]+)\)$/);
                    if (qualityMatch) {
                        const possibleQuality = qualityMatch[1];
                        // Проверяем, соответствует ли это качеству
                        const qualities = ['Factory New', 'Minimal Wear', 'Field-Tested', 'Well-Worn', 'Battle-Scarred'];
                        if (qualities.includes(possibleQuality)) {
                            skinQuality = possibleQuality;
                            skinName = skinName.replace(/\s*\([^)]+\)$/, '').trim();
                        }
                    }
                }
                
                document.getElementById('skinName').value = skinName;
                document.getElementById('skinType').value = skinType;
                document.getElementById('skinQuality').value = skinQuality;
                document.getElementById('buyPrice').value = t.buyPrice;
                document.getElementById('sellPrice').value = t.sellPrice;
                document.getElementById('profitPercentage').value = t.commission;
                document.getElementById('advancedDate').value = t.date;
                calculateProfit();
            } else {
                document.getElementById('type').value = t.type;
                document.getElementById('amount').value = t.amount;
                document.getElementById('description').value = t.description;
                document.getElementById('date').value = t.date;
            }
            
            openModal();
            hasChanges = false;
        }

        function confirmDelete(index) {
            // Сохраняем индекс транзакции для удаления
            currentDeletingIndex = index;
            
            // Показываем модальное окно подтверждения
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'block';
            
            // Анимация появления
            const modalContent = modal.querySelector('.confirm-modal-content');
            gsap.fromTo(modalContent, 
                { opacity: 0, scale: 0.9 },
                { opacity: 1, scale: 1, duration: 0.3, ease: "back.out(1.7)" }
            );
            
            // Добавляем обработчик для кнопки "OK"
            document.getElementById('deleteConfirmButton').onclick = function() {
                closeDeleteConfirmModal();
                deleteTransaction(currentDeletingIndex);
            };
        }
        
        function closeDeleteConfirmModal() {
            const modal = document.getElementById('deleteConfirmModal');
            const modalContent = modal.querySelector('.confirm-modal-content');
            
            // Анимация исчезновения
            gsap.to(modalContent, {
                opacity: 0,
                y: 20,
                scale: 0.95,
                duration: 0.2,
                ease: "power2.in",
                onComplete: () => {
                    modal.style.display = 'none';
                }
            });
        }

        function deleteTransaction(index) {
            // Create sparkles effect before removing
            const transactionElement = document.querySelector(`.transaction-item[data-index="${index}"]`);
            if (transactionElement) {
                createSparklesAround(transactionElement, 15);
                
                // Animate removal
                gsap.to(transactionElement, {
                    opacity: 0,
                    x: 100,
                    duration: 0.5,
                    ease: "power2.in",
                    onComplete: () => {
                        transactions.splice(index, 1);
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        updateUI();
                        
                        // Show notification
                        showNotification('Транзакция удалена', 'info');
                    }
                });
            } else {
                transactions.splice(index, 1);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                updateUI();
                
                // Show notification
                showNotification('Транзакция удалена', 'info');
            }
        }

        function openModal() {
            const modal = document.getElementById('transactionModal');
            modal.style.display = 'block';
            
            // Animate modal appearance
            const modalContent = modal.querySelector('.modal-content');
            gsap.fromTo(modalContent, 
                { opacity: 0, y: 20, scale: 0.95 },
                { opacity: 1, y: 0, scale: 1, duration: 0.5, ease: "back.out(1.7)" }
            );
            
            hasChanges = false;
        }

        function closeModal() {
            const modal = document.getElementById('transactionModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Animate modal disappearance
            gsap.to(modalContent, {
                opacity: 0,
                y: 20,
                scale: 0.95,
                duration: 0.3,
                ease: "power2.in",
                onComplete: () => {
                    modal.style.display = 'none';
                    clearInputs();
                    editingTransactionIndex = null;
                    hasChanges = false;
                    restoreTransactionsView(); // Восстанавливаем выбранный вид
                }
            });
        }

        function closeModalWithConfirmation() {
            if (hasChanges) {
                document.getElementById('confirmModal').style.display = 'block';
                
                // Animate confirm modal appearance
                const confirmContent = document.querySelector('.confirm-modal-content');
                gsap.fromTo(confirmContent, 
                    { opacity: 0, scale: 0.9 },
                    { opacity: 1, scale: 1, duration: 0.3, ease: "back.out(1.7)" }
                );
            } else {
                closeModal();
            }
        }

        function confirmCloseModal(confirmed) {
            const confirmModal = document.getElementById('confirmModal');
            const confirmContent = confirmModal.querySelector('.confirm-modal-content');
            
            // Animate confirm modal disappearance
            gsap.to(confirmContent, {
                opacity: 0,
                y: 20,
                scale: 0.95,
                duration: 0.2,
                ease: "power2.in",
                onComplete: () => {
                    confirmModal.style.display = 'none';
                    if (confirmed) {
                        closeModal();
                    }
                }
            });
        }

        function updateChart() {
            const filteredTransactions = filterTransactionsByPeriod(transactions, currentPeriod);
            
            // Sort transactions by date
            filteredTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Calculate running balance
            let balance = 0;
            const labels = [];
            const data = [];
            
            filteredTransactions.forEach(t => {
                balance = t.type === 'income' ? balance + t.amount : balance - t.amount;
                labels.push(new Date(t.date).toLocaleDateString('ru-RU', { 
                    month: 'short', 
                    day: 'numeric' 
                }));
                data.push(balance);
            });

            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }

        function updateUI() {
            updateBalance();
            updateProfitLoss();
            updateChart();
            renderTransactions();
            renderCalendar();
        }

        function changePeriod(period) {
            currentPeriod = period;
            
            // Update active button with animation
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                if (btn.textContent.toLowerCase() === period || 
                    (period === 'all' && btn.textContent === 'Все')) {
                    
                    // Animate the button becoming active
                    gsap.fromTo(btn, 
                        { scale: 1 },
                        { 
                            scale: 1.1, 
                            duration: 0.2, 
                            ease: "back.out(1.7)",
                            onComplete: () => {
                                gsap.to(btn, { scale: 1, duration: 0.1 });
                            }
                        }
                    );
                    
                    btn.classList.add('btn-active');
                    createSparklesAround(btn, 5);
                } else {
                    btn.classList.remove('btn-active');
                }
            });
            
            updateUI();
        }

        function filterTransactionsByPeriod(transactions, period) {
            const now = new Date();
            let startDate;

            switch(period) {
                case 'day':
                    startDate = new Date(now);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate = new Date(now);
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                default:
                    return [...transactions];
            }

            return transactions.filter(t => new Date(t.date) >= startDate);
        }

        function filterTransactions() {
            const searchDate = document.getElementById('searchDate').value;
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const searchAmount = document.getElementById('searchAmount').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            // Фильтрация по критериям
            let filteredTransactions = [...transactions];
            
            if (searchDate) {
                filteredTransactions = filteredTransactions.filter(t => t.date === searchDate);
            }
            
            if (searchName) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.description && t.description.toLowerCase().includes(searchName)
                );
            }
            
            if (searchAmount) {
                const amount = parseFloat(searchAmount);
                filteredTransactions = filteredTransactions.filter(t => 
                    t.amount === amount || 
                    Math.abs(t.amount - amount) < 0.01 // Для неточного совпадения
                );
            }
            
            // Сортировка
            switch (sortOrder) {
                case 'newest':
                    filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'oldest':
                    filteredTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'highest':
                    filteredTransactions.sort((a, b) => b.amount - a.amount);
                    break;
                case 'lowest':
                    filteredTransactions.sort((a, b) => a.amount - b.amount);
                    break;
                case 'profitable':
                    // Фильтрация только прибыльных сделок (income)
                    filteredTransactions = filteredTransactions.filter(t => t.type === 'income');
                    // Сортировка по проценту прибыли (если есть) или по сумме
                    filteredTransactions.sort((a, b) => {
                        if (a.profitPercent && b.profitPercent) {
                            return parseFloat(b.profitPercent) - parseFloat(a.profitPercent);
                        }
                        return b.amount - a.amount;
                    });
                    break;
                case 'unprofitable':
                    // Фильтрация только убыточных сделок (expense)
                    filteredTransactions = filteredTransactions.filter(t => t.type === 'expense');
                    // Сортировка по проценту убытка (если есть) или по сумме
                    filteredTransactions.sort((a, b) => {
                        if (a.profitPercent && b.profitPercent) {
                            return parseFloat(b.profitPercent) - parseFloat(a.profitPercent);
                        }
                        return b.amount - a.amount;
                    });
                    break;
            }
            
            const container = document.getElementById('transactions');
            if (filteredTransactions.length === 0) {
                container.innerHTML = `
                    <div class="transaction-item" style="justify-content: center; text-align: center;">
                        <p>Нет транзакций по заданным критериям</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredTransactions.map((t, i) => {
                // Показываем проценты только если есть данные о покупке и продаже
                const showPercent = t.buyPrice && t.sellPrice && t.profitPercent;
                
                return `
                <div class="transaction-item" data-index="${transactions.indexOf(t)}">
                    <div class="transaction-info">
                        <h4>${t.description}</h4>
                        <small>${new Date(t.date).toLocaleDateString()}</small>
                    </div>
                    <div class="transaction-actions">
                        <span class="transaction-amount ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString()}
                            ${showPercent ? `<span class="profit-percent">(${t.type === 'income' ? '+' : '-'}${t.profitPercent}%)</span>` : ''}
                        </span>
                        <button onclick="editTransaction(${transactions.indexOf(t)})" class="btn btn-secondary btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button onclick="confirmDelete(${transactions.indexOf(t)})" class="btn btn-secondary btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
            // Add animation to filtered items
            const items = document.querySelectorAll('.transaction-item');
            items.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.05}s`;
                
                // Add hover effect listeners for sparkles
                item.addEventListener('mouseenter', function() {
                    createSparklesAround(this, 5);
                });
            });
        }

        function clearInputs() {
            document.getElementById('type').value = 'income';
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            document.getElementById('date').value = '';
            document.getElementById('skinName').value = '';
            document.getElementById('skinQuality').value = '';
            document.getElementById('skinType').value = 'Normal';
            document.getElementById('buyPrice').value = '';
            document.getElementById('sellPrice').value = '';
            document.getElementById('profitPercentage').value = '2';
            document.getElementById('advancedDate').value = '';
            document.getElementById('calculationResult').innerHTML = '';
            document.getElementById('calculationResult').style.display = 'none';
            document.getElementById('addAdvancedTransactionBtn').style.display = 'none';
            document.getElementById('addTransactionBtn').style.display = 'block';
        }

        function toggleTransactionFields() {
            const type = document.getElementById('transactionType').value;
            const simpleFields = document.getElementById('simpleTransactionFields');
            const advancedFields = document.getElementById('advancedTransactionFields');
            const calculatorFields = document.getElementById('calculatorFields');
            const calculationResult = document.getElementById('calculationResult');
            
            if (type === 'simple') {
                // Animate transition
                gsap.to(advancedFields, { opacity: 0, height: 0, duration: 0.3, display: 'none' });
                gsap.to(calculatorFields, { opacity: 0, height: 0, duration: 0.3, display: 'none' });
                gsap.fromTo(simpleFields, 
                    { opacity: 0, height: 0 },
                    { opacity: 1, height: 'auto', duration: 0.3, display: 'block' }
                );
                
                document.getElementById('addTransactionBtn').style.display = 'block';
                document.getElementById('addAdvancedTransactionBtn').style.display = 'none';
            } else if (type === 'advanced') {
                // Animate transition
                gsap.to(simpleFields, { opacity: 0, height: 0, duration: 0.3, display: 'none' });
                gsap.to(calculatorFields, { opacity: 0, height: 0, duration: 0.3, display: 'none' });
                gsap.fromTo(advancedFields, 
                    { opacity: 0, height: 0 },
                    { opacity: 1, height: 'auto', duration: 0.3, display: 'block' }
                );
                
                document.getElementById('addTransactionBtn').style.display = 'none';
                
                // Preserve calculation result if it exists
                if (calculationResult.innerHTML !== '') {
                    calculationResult.style.display = 'block';
                    document.getElementById('addAdvancedTransactionBtn').style.display = 'block';
                }
            } else if (type === 'calculator') {
                // Animate transition
                gsap.to(simpleFields, { opacity: 0, height: 0, duration: 0.3, display: 'none' });
                gsap.to(advancedFields, { opacity: 0, height: 0, duration: 0.3, display: 'none' });
                gsap.fromTo(calculatorFields, 
                    { opacity: 0, height: 0 },
                    { opacity: 1, height: 'auto', duration: 0.3, display: 'block' }
                );
                
                document.getElementById('addTransactionBtn').style.display = 'none';
                document.getElementById('addAdvancedTransactionBtn').style.display = 'none';
            }
        }

        function createSparklesAround(element, count = 10) {
            if (!element) return;
            
            const rect = element.getBoundingClientRect();
            
            for (let i = 0; i < count; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                
                // Random position around the element
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 50 + 20;
                const x = rect.left + rect.width / 2 + Math.cos(angle) * distance;
                const y = rect.top + rect.height / 2 + Math.sin(angle) * distance;
                
                sparkle.style.left = `${x}px`;
                sparkle.style.top = `${y}px`;
                
                document.body.appendChild(sparkle);
                
                // Animate the sparkle
                gsap.to(sparkle, {
                    scale: Math.random() * 2 + 1,
                    opacity: 1,
                    duration: 0.3,
                    ease: "power1.out",
                    onComplete: () => {
                        gsap.to(sparkle, {
                            scale: 0,
                            opacity: 0,
                            duration: 0.5,
                            delay: Math.random() * 0.5,
                            ease: "power1.in",
                            onComplete: () => {
                                sparkle.remove();
                            }
                        });
                    }
                });
            }
        }

        function toggleThemeMenu() {
            const themeMenu = document.getElementById('theme-menu');
            themeMenu.classList.toggle('active');
            
            // Если меню открыто, добавляем обработчик для закрытия при клике вне меню
            if (themeMenu.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closeThemeMenuOnClickOutside);
                }, 10);
                
                // Создаем эффект искр
                createSparklesAround(document.querySelector('.theme-toggle'), 10);
            }
        }

        // Функция для закрытия меню при клике вне его
        function closeThemeMenuOnClickOutside(event) {
            const themeMenu = document.getElementById('theme-menu');
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (!themeMenu.contains(event.target) && !themeToggle.contains(event.target)) {
                themeMenu.classList.remove('active');
                document.removeEventListener('click', closeThemeMenuOnClickOutside);
            }
        }

        // Функция для установки активной темы в меню
        function setActiveThemeOption() {
            const root = document.documentElement;
            let currentTheme = 'dark'; // По умолчанию темная тема
            
            if (root.classList.contains('light-theme')) {
                currentTheme = 'light';
            } else if (root.classList.contains('pink-theme')) {
                currentTheme = 'pink';
            }
            
            // Удаляем активный класс со всех опций
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Добавляем активный класс на текущую тему
            const activeOption = document.querySelector(`.theme-option[data-theme="${currentTheme}"]`);
            if (activeOption) {
                activeOption.classList.add('active');
            }
        }

        // Функция для установки темы
        function setTheme(theme) {
            const root = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            
            // Удаляем все классы тем
            root.classList.remove('light-theme', 'pink-theme');
            
            // Устанавливаем выбранную тему
            if (theme === 'light') {
                root.classList.add('light-theme');
                updateThemeIcon('light');
            } else if (theme === 'pink') {
                root.classList.add('pink-theme');
                updateThemeIcon('pink');
            } else {
                // Темная тема (по умолчанию)
                updateThemeIcon('dark');
            }
            
            // Сохраняем выбранную тему в localStorage
            localStorage.setItem('selectedTheme', theme);
            
            // Обновляем активную опцию в меню
            setActiveThemeOption();
            
            // Создаем эффект вспышки при смене темы
            createThemeChangeFlash(theme);
            
            // Update chart colors
            updateChartColors();
            
            // Create or remove cherry blossoms based on theme
            if (theme === 'pink') {
                createCherryBlossoms();
            } else {
                removeCherryBlossoms();
            }
        }

        // Функция для обновления иконки темы
        function updateThemeIcon(theme) {
            const moon = document.getElementById('moon');
            const sun = document.getElementById('sun');
            const sunRays = document.querySelectorAll('[id^="sun-ray-"]');
            const cherry = document.getElementById('cherry');
            
            // Скрываем все элементы
            moon.style.display = 'none';
            sun.style.display = 'none';
            cherry.style.display = 'none';
            sunRays.forEach(ray => ray.style.display = 'none');
            
            // Показываем нужные элементы в зависимости от темы
            if (theme === 'light') {
                sun.style.display = 'block';
                sunRays.forEach(ray => ray.style.display = 'block');
            } else if (theme === 'pink') {
                cherry.style.display = 'block';
            } else {
                moon.style.display = 'block';
            }
        }

        // Функция для создания эффекта вспышки при смене темы
        function createThemeChangeFlash(theme) {
            const flash = document.createElement('div');
            flash.style.position = 'fixed';
            flash.style.top = '0';
            flash.style.left = '0';
            flash.style.width = '100%';
            flash.style.height = '100%';
            flash.style.zIndex = '9998';
            flash.style.pointerEvents = 'none';
            
            // Цвет вспышки в зависимости от темы
            if (theme === 'light') {
                flash.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
            } else if (theme === 'pink') {
                flash.style.backgroundColor = 'rgba(236, 72, 153, 0.2)';
            } else {
                flash.style.backgroundColor = 'rgba(15, 23, 42, 0.2)';
            }
            
            document.body.appendChild(flash);
            
            gsap.to(flash, {
                opacity: 0,
                duration: 0.5,
                onComplete: () => {
                    flash.remove();
                }
            });
        }

        // Function to update chart colors
        function updateChartColors() {
            const root = document.documentElement;
            const isDarkTheme = !root.classList.contains('light-theme') && !root.classList.contains('pink-theme');
            const isPinkTheme = root.classList.contains('pink-theme');
            
            let primaryColor = '#4f46e5'; // Default color for dark theme
            
            if (isPinkTheme) {
                primaryColor = '#ec4899'; // Pink color for pink theme
            }
            
            // Update chart colors
            if (chart) {
                chart.data.datasets[0].borderColor = primaryColor;
                chart.data.datasets[0].pointBackgroundColor = primaryColor;
                chart.data.datasets[0].pointHoverBackgroundColor = primaryColor;
                
                // Update gradient
                const ctx = document.getElementById('mainChart').getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                
                if (isPinkTheme) {
                    gradient.addColorStop(0, 'rgba(236, 72, 153, 0.3)');
                    gradient.addColorStop(0.5, 'rgba(244, 114, 182, 0.15)');
                    gradient.addColorStop(1, 'rgba(192, 38, 211, 0.05)');
                } else {
                    gradient.addColorStop(0, 'rgba(79, 70, 229, 0.3)');
                    gradient.addColorStop(0.5, 'rgba(139, 92, 246, 0.15)');
                    gradient.addColorStop(1, 'rgba(236, 72, 153, 0.05)');
                }
                
                chart.data.datasets[0].backgroundColor = gradient;
                
                // Update grid and text colors
                const newChartOptions = {
                    scales: {
                        x: { 
                            grid: { color: isDarkTheme ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' },
                            ticks: { color: isDarkTheme ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)' }
                        },
                        y: { 
                            grid: { color: isDarkTheme ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' },
                            ticks: { 
                                color: isDarkTheme ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)',
                                callback: value => '$' + value.toLocaleString()
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: isDarkTheme ? 'rgba(15,23,42,0.9)' : 'rgba(248,250,252,0.9)',
                            bodyColor: isDarkTheme ? '#fff' : '#000',
                            borderColor: isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                        }
                    }
                };
                
                chart.options.scales.x.grid.color = newChartOptions.scales.x.grid.color;
                chart.options.scales.x.ticks.color = newChartOptions.scales.x.ticks.color;
                chart.options.scales.y.grid.color = newChartOptions.scales.y.grid.color;
                chart.options.scales.y.ticks.color = newChartOptions.scales.y.ticks.color;
                chart.options.plugins.tooltip = newChartOptions.plugins.tooltip;
                chart.update();
            }
        }

        // Function to create cherry blossoms
        function createCherryBlossoms() {
            // Remove existing blossoms
            removeCherryBlossoms();
            
            // Create new blossoms
            for (let i = 0; i < 30; i++) {
                createCherryBlossom();
            }
            
            // Continue creating new blossoms at intervals
            window.cherryBlossomInterval = setInterval(createCherryBlossom, 500);
        }

        function createCherryBlossom() {
            const blossom = document.createElement('div');
            blossom.className = 'cherry-blossom';
            
            // Random horizontal position
            blossom.style.left = `${Math.random() * 100}vw`;
            
            // Random size
            const size = Math.random() * 10 + 10;
            blossom.style.width = `${size}px`;
            blossom.style.height = `${size}px`;
            
            // Random fall speed
            const duration = Math.random() * 10 + 5;
            blossom.style.animationDuration = `${duration}s`;
            
            // Random rotation
            blossom.style.transform = `rotate(${Math.random() * 360}deg)`;
            
            document.body.appendChild(blossom);
            
            // Remove blossom after animation completes
            setTimeout(() => {
                if (blossom && blossom.parentNode) {
                    blossom.remove();
                }
            }, duration * 1000);
        }

        // Function to remove cherry blossoms
        function removeCherryBlossoms() {
            // Clear interval for creating blossoms
            if (window.cherryBlossomInterval) {
                clearInterval(window.cherryBlossomInterval);
            }
            
            // Remove all existing blossoms
            const blossoms = document.querySelectorAll('.cherry-blossom');
            blossoms.forEach(blossom => {
                blossom.remove();
            });
        }

        // Function to load saved theme
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme) {
                setTheme(savedTheme);
            } else {
                // Set pink theme by default as requested
                setTheme('pink');
            }
        }

        function switchToCalendar() {
            const chartContainer = document.querySelector('.chart-container');
            const calendarContainer = document.querySelector('.calendar-container');
            const rightButton = document.querySelector('.switch-view.right');
            const leftButton = document.querySelector('.switch-view.left');

            gsap.to(chartContainer, { 
                opacity: 0, 
                x: -50,
                duration: 0.5, 
                ease: "power2.inOut",
                onComplete: () => {
                    chartContainer.style.display = 'none';
                    calendarContainer.style.display = 'block';
                    gsap.fromTo(calendarContainer, 
                        { opacity: 0, x: 50 }, 
                        { opacity: 1, x: 0, duration: 0.5, ease: "power2.out" }
                    );
                }
            });

            rightButton.style.display = 'none';
            leftButton.style.display = 'flex';
            renderCalendar();
            
            // Create sparkles effect
            createSparklesAround(rightButton, 10);
        }

        function switchToChart() {
            const chartContainer = document.querySelector('.chart-container');
            const calendarContainer = document.querySelector('.calendar-container');
            const rightButton = document.querySelector('.switch-view.right');
            const leftButton = document.querySelector('.switch-view.left');

            gsap.to(calendarContainer, { 
                opacity: 0, 
                x: 50,
                duration: 0.5, 
                ease: "power2.inOut",
                onComplete: () => {
                    calendarContainer.style.display = 'none';
                    chartContainer.style.display = 'block';
                    gsap.fromTo(chartContainer, 
                        { opacity: 0, x: -50 }, 
                        { opacity: 1, x: 0, duration: 0.5, ease: "power2.out" }
                    );
                }
            });

            leftButton.style.display = 'none';
            rightButton.style.display = 'flex';
            
            // Create sparkles effect
            createSparklesAround(leftButton, 10);
        }

        function renderCalendar() {
            if (!document.getElementById('calendarGrid')) return;
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');

            // Clear current calendar
            calendarGrid.innerHTML = '';

            // Set current month and year
            currentMonthElement.textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            // Get first and last day of month
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

            // Add weekday headers
            const weekdays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            });

            // Add empty cells before first day of month
            for (let i = 0; i < (firstDay.getDay() || 7) - 1; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarGrid.appendChild(emptyDay);
            }

            // Add days of month with animation
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.style.opacity = 0;
                dayElement.style.transform = 'scale(0.8)';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = i;
                
                const dayBalance = document.createElement('div');
                dayBalance.className = 'day-balance';
                
                const currentDayTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getDate() === i &&
                           transactionDate.getMonth() === currentDate.getMonth() &&
                           transactionDate.getFullYear() === currentDate.getFullYear();
                });
                
                let dayTotal = 0;
                currentDayTransactions.forEach(t => {
                    dayTotal = t.type === 'income' ? dayTotal + t.amount : dayTotal - t.amount;
                });
                
                if (dayTotal !== 0) {
                    dayBalance.textContent = `${dayTotal > 0 ? '+' : ''}$${dayTotal.toLocaleString()}`;
                    dayBalance.classList.add(dayTotal > 0 ? 'positive-balance' : 'negative-balance');
                }
                
                dayElement.appendChild(dayNumber);
                dayElement.appendChild(dayBalance);
                
                if (i === new Date().getDate() && 
                    currentDate.getMonth() === new Date().getMonth() && 
                    currentDate.getFullYear() === new Date().getFullYear()) {
                    dayElement.classList.add('today');
                }
                
                // Add click handler to filter transactions by date
                dayElement.addEventListener('click', function() {
                    const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                    document.getElementById('searchDate').value = selectedDate.toISOString().split('T')[0];
                    filterTransactions();
                    switchToChart();
                    
                    // Create sparkles effect
                    createSparklesAround(this, 10);
                });
                
                calendarGrid.appendChild(dayElement);
                
                // Animate day appearance with delay
                gsap.to(dayElement, {
                    opacity: 1,
                    scale: 1,
                    duration: 0.3,
                    delay: i * 0.02,
                    ease: "back.out(1.7)"
                });
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            
            // Animate month change
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            
            gsap.to(calendarGrid, {
                opacity: 0,
                scale: delta > 0 ? 0.9 : 1.1,
                x: delta > 0 ? -30 : 30,
                duration: 0.3,
                onComplete: () => {
                    renderCalendar();
                    gsap.fromTo(calendarGrid, 
                        { opacity: 0, scale: delta > 0 ? 1.1 : 0.9, x: delta > 0 ? 30 : -30 }, 
                        { opacity: 1, scale: 1, x: 0, duration: 0.3 }
                    );
                }
            });
            
            // Animate month title
            gsap.to(currentMonthElement, {
                opacity: 0,
                y: delta > 0 ? -20 : 20,
                duration: 0.3,
                onComplete: () => {
                    currentMonthElement.textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                    gsap.fromTo(currentMonthElement, 
                        { opacity: 0, y: delta > 0 ? 20 : -20 }, 
                        { opacity: 1, y: 0, duration: 0.3 }
                    );
                }
            });
        }

        // Initialize glow cursor
        function initGlowCursor() {
            const cursor = document.querySelector('.glow-cursor');
            
            document.addEventListener('mousemove', (e) => {
                cursor.style.left = `${e.clientX - 15}px`;
                cursor.style.top = `${e.clientY - 15}px`;
                cursor.style.opacity = '1';
                
                // Check if cursor is over an interactive element
                const target = e.target;
                const isInteractive = 
                    target.tagName === 'BUTTON' || 
                    target.tagName === 'A' || 
                    target.classList.contains('btn') ||
                    target.classList.contains('card') ||
                    target.classList.contains('transaction-item') ||
                    target.classList.contains('calendar-day') ||
                    target.classList.contains('theme-option') ||
                    target.closest('.btn') ||
                    target.closest('.card') ||
                    target.closest('.transaction-item') ||
                    target.closest('.calendar-day') ||
                    target.closest('.theme-option');
                
                if (isInteractive) {
                    cursor.style.transform = 'scale(1.5)';
                    cursor.style.mixBlendMode = 'screen';
                } else {
                    cursor.style.transform = 'scale(1)';
                    cursor.style.mixBlendMode = 'screen';
                }
            });
            
            document.addEventListener('mouseout', () => {
                cursor.style.opacity = '0';
            });
        }

        function createParticles() {
            const container = document.getElementById('particles');
            const particleCount = 20;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Случайное положение
                const startX = Math.random() * 200 - 100;
                const startY = Math.random() * 200 - 100;
                
                // Случайное направление движения
                const tx = (Math.random() - 0.5) * 200;
                const ty = (Math.random() - 0.5) * 200;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                particle.style.left = `${startX + 100}px`;
                particle.style.top = `${startY + 100}px`;
                particle.style.animation = `particleFloat ${1 + Math.random()}s ease-in-out infinite`;
                particle.style.animationDelay = `${Math.random() * 2}s`;
                
                container.appendChild(particle);
            }
        }

        function createStars() {
            const starsContainer = document.createElement('div');
            starsContainer.className = 'stars-container';
            document.body.appendChild(starsContainer);

            for (let i = 0; i < 30; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}vw`;
                star.style.animationDuration = `${Math.random() * 10 + 5}s`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                starsContainer.appendChild(star);
            }
        }

        function openStatsModal() {
            document.getElementById('statsModal').style.display = 'block';
            
            // Animate modal appearance
            const modalContent = document.querySelector('#statsModal .modal-content');
            gsap.fromTo(modalContent, 
                { opacity: 0, y: 20, scale: 0.95 },
                { opacity: 1, y: 0, scale: 1, duration: 0.5, ease: "back.out(1.7)" }
            );
            
            updateStats();
            
            // Create sparkles effect
            createSparklesAround(document.querySelector('.btn-primary.btn-large'), 15);
        }

        function closeStatsModal() {
            const modal = document.getElementById('statsModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Animate modal disappearance
            gsap.to(modalContent, {
                opacity: 0,
                y: 20,
                scale: 0.95,
                duration: 0.3,
                ease: "power2.in",
                onComplete: () => {
                    modal.style.display = 'none';
                    restoreTransactionsView(); // Восстанавливаем выбранный вид
                }
            });
        }

        function updateStats() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const weekAgo = new Date(now);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const monthAgo = new Date(now);
            monthAgo.setMonth(monthAgo.getMonth() - 1);

            const todayStats = calculateStats(transactions.filter(t => t.date === today));
            const yesterdayStats = calculateStats(transactions.filter(t => t.date === yesterdayStr));
            const weekStats = calculateStats(transactions.filter(t => new Date(t.date) >= weekAgo));
            const monthStats = calculateStats(transactions.filter(t => new Date(t.date) >= monthAgo));
            const totalStats = calculateStats(transactions);

            // Animate stats update
            animateValue(document.getElementById('todayEarnings'), 0, todayStats.earnings, 1000, '$');
            document.getElementById('todayDeals').textContent = `${todayStats.deals} сделок`;
            
            animateValue(document.getElementById('yesterdayEarnings'), 0, yesterdayStats.earnings, 1000, '$');
            document.getElementById('yesterdayDeals').textContent = `${yesterdayStats.deals} сделок`;
            
            animateValue(document.getElementById('weekEarnings'), 0, weekStats.earnings, 1000, '$');
            document.getElementById('weekDeals').textContent = `${weekStats.deals} сделок`;
            
            animateValue(document.getElementById('monthEarnings'), 0, monthStats.earnings, 1000, '$');
            document.getElementById('monthDeals').textContent = `${monthStats.deals} сделок`;
            
            animateValue(document.getElementById('totalEarnings'), 0, totalStats.earnings, 1000, '$');
            document.getElementById('totalDeals').textContent = `${totalStats.deals} сделок`;
            
            // Add classes for styling positive/negative values
            document.getElementById('todayEarnings').className = todayStats.earnings >= 0 ? 'positive' : 'negative';
            document.getElementById('yesterdayEarnings').className = yesterdayStats.earnings >= 0 ? 'positive' : 'negative';
            document.getElementById('weekEarnings').className = weekStats.earnings >= 0 ? 'positive' : 'negative';
            document.getElementById('monthEarnings').className = monthStats.earnings >= 0 ? 'positive' : 'negative';
            document.getElementById('totalEarnings').className = totalStats.earnings >= 0 ? 'positive' : 'negative';
        }

        function calculateStats(transactions) {
            let income = 0;
            let expense = 0;
            
            transactions.forEach(t => {
                if (t.type === 'income') {
                    income += t.amount;
                } else {
                    expense += t.amount;
                }
            });
            
            const earnings = income - expense;
            const deals = transactions.length;
            return { earnings, deals };
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('advancedDate').value = today;
            
            // Initialize chart and update UI
            initChart();
            updateUI();
            
            // Create visual effects
            createParticles();
            createStars();
            initGlowCursor();
            
            // Hide left view switch button
            document.querySelector('.switch-view.left').style.display = 'none';
            
            // Load saved theme (or set pink theme by default)
            loadSavedTheme();
            
            // Set active theme in menu
            setActiveThemeOption();
        });

        // Функция для переключения темы
        function toggleTheme() {
            const root = document.documentElement;
            const currentTheme = root.classList.contains('light-theme') ? 'light' : 
                                root.classList.contains('pink-theme') ? 'pink' : 'dark';
            let nextTheme;
            
            // Определяем следующую тему
            switch(currentTheme) {
                case 'dark':
                    nextTheme = 'light';
                    break;
                case 'light':
                    nextTheme = 'pink';
                    break;
                case 'pink':
                    nextTheme = 'dark';
                    break;
            }
            
            // Создаем эффект перехода
            const transition = document.createElement('div');
            transition.className = 'theme-transition';
            document.body.appendChild(transition);
            
            // Анимируем переход
            requestAnimationFrame(() => {
                transition.style.opacity = '1';
                
                setTimeout(() => {
                    // Удаляем все классы тем
                    root.classList.remove('light-theme', 'pink-theme');
                    
                    // Добавляем новую тему
                    if (nextTheme === 'light') {
                        root.classList.add('light-theme');
                    } else if (nextTheme === 'pink') {
                        root.classList.add('pink-theme');
                    }
                    
                    // Обновляем иконку
                    const moonPath = document.getElementById('moon');
                    const sunElements = document.querySelectorAll('#sun, #sun-ray-1, #sun-ray-2, #sun-ray-3, #sun-ray-4, #sun-ray-5, #sun-ray-6, #sun-ray-7, #sun-ray-8');
                    const heartPath = document.getElementById('heart');
                    
                    moonPath.style.display = 'none';
                    sunElements.forEach(el => el.style.display = 'none');
                    heartPath.style.display = 'none';
                    
                    switch(nextTheme) {
                        case 'dark':
                            moonPath.style.display = 'block';
                            break;
                        case 'light':
                            sunElements.forEach(el => el.style.display = 'block');
                            break;
                        case 'pink':
                            heartPath.style.display = 'block';
                            break;
                    }
                    
                    // Плавно убираем эффект перехода
                    setTimeout(() => {
                        transition.style.opacity = '0';
                        setTimeout(() => transition.remove(), 300);
                    }, 50);
                }, 150);
            });
            
            // Сохраняем выбранную тему
            localStorage.setItem('theme', nextTheme);
        }

        // Функция для инициализации темы при загрузке
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const root = document.documentElement;
            
            // Удаляем все классы тем
            root.classList.remove('light-theme', 'pink-theme');
            
            // Устанавливаем сохраненную тему или тему по умолчанию
            if (savedTheme) {
                if (savedTheme === 'light') {
                    root.classList.add('light-theme');
                } else if (savedTheme === 'pink') {
                    root.classList.add('pink-theme');
                }
            } else if (!prefersDark) {
                root.classList.add('light-theme');
            }
            
            // Обновляем иконку
            const moonPath = document.getElementById('moon');
            const sunElements = document.querySelectorAll('#sun, #sun-ray-1, #sun-ray-2, #sun-ray-3, #sun-ray-4, #sun-ray-5, #sun-ray-6, #sun-ray-7, #sun-ray-8');
            const heartPath = document.getElementById('heart');
            
            moonPath.style.display = 'none';
            sunElements.forEach(el => el.style.display = 'none');
            heartPath.style.display = 'none';
            
            if (savedTheme === 'light' || (!savedTheme && !prefersDark)) {
                sunElements.forEach(el => el.style.display = 'block');
            } else if (savedTheme === 'pink') {
                heartPath.style.display = 'block';
            } else {
                moonPath.style.display = 'block';
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', initTheme);

        // Функция для скрытия загрузчика
        function hideLoader() {
            const loader = document.getElementById('loader');
            loader.classList.add('loader-fade-out');
            setTimeout(() => {
                loader.style.display = 'none';
            }, 500);
        }

        // Показываем загрузчик при загрузке страницы
        window.addEventListener('load', () => {
            setTimeout(hideLoader, 1500); // 1.5 секунды
        });

        // Показываем загрузчик при обновлении страницы
        window.addEventListener('beforeunload', () => {
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            loader.classList.remove('loader-fade-out');
        });

        // Полностью меняем функцию updateLegacyTransactions, чтобы она ТОЛЬКО удаляла проценты
        function updateLegacyTransactions() {
            let needsUpdate = false;
            
            // Проходим по всем транзакциям и удаляем проценты, кроме сделок с buyPrice и sellPrice
            transactions.forEach(transaction => {
                // Оставляем проценты только для сделок с данными о покупке и продаже
                if (!transaction.buyPrice || !transaction.sellPrice) {
                    if (transaction.profitPercent) {
                        delete transaction.profitPercent;
                        needsUpdate = true;
                    }
                }
            });
            
            // Если были изменения, сохраняем обновленные транзакции
            if (needsUpdate) {
                localStorage.setItem('transactions', JSON.stringify(transactions));
                console.log('Removed profit percentages from legacy transactions without buy/sell prices');
            }
        }
        
        // Удаляем функцию forceUpdateAllTransactionPercents полностью

        document.addEventListener('DOMContentLoaded', () => {
            // Получаем транзакции из localStorage
            const storedTransactions = localStorage.getItem('transactions');
            if (storedTransactions) {
                try {
                    transactions = JSON.parse(storedTransactions);
                } catch (e) {
                    console.error('Ошибка при парсинге транзакций:', e);
                }
            }
            
            // Привязываем события автоматического расчета
            bindAutoCalculateEvents();
            
            updateLegacyTransactions();
            updateUI();
            initParticles();
            initStats();
            
            // Загружаем предпочтения темы
            loadThemePreference();
        });

        // Функции для работы с Мои скины
        let mySkins = JSON.parse(localStorage.getItem('mySkins')) || [];
        let editingSkinIndex = null;
        let currentSaleSkinIndex = null;
        let lastCalculatedSaleProfit = 0;
        let skinToDeleteIndex = null;
        
        function openMySkinsModal() {
            document.getElementById('mySkinsModal').style.display = 'block';
            updateMySkinsList();
            
            // Проверяем было ли инфо скрыто в последний раз
            const infoBox = document.getElementById('mySkinsInfo');
            const infoToggle = document.querySelector('.info-toggle');
            
            // По умолчанию показываем инфо блок при первом открытии
            if (sessionStorage.getItem('mySkinsInfoState') === 'hidden') {
                infoBox.style.display = 'none';
                infoToggle.style.display = 'block';
            } else {
                infoBox.style.display = 'block';
                infoToggle.style.display = 'none';
            }
            
            // Создаем эффект искр вокруг кнопки
            createSparklesAround(document.querySelector('.myskins-btn'), 15);
        }
        
        function closeMySkinsModal() {
            document.getElementById('mySkinsModal').style.display = 'none';
            restoreTransactionsView(); // Восстанавливаем выбранный вид
        }
        
        function toggleMySkinsInfo() {
            const mySkinsInfo = document.getElementById('mySkinsInfo');
            const infoToggle = document.querySelector('.info-toggle');
            
            if (mySkinsInfo.style.display === 'none') {
                mySkinsInfo.style.display = 'block';
                infoToggle.style.display = 'none';
                sessionStorage.setItem('mySkinsInfoState', 'visible');
            } else {
                mySkinsInfo.style.display = 'none';
                infoToggle.style.display = 'block';
                sessionStorage.setItem('mySkinsInfoState', 'hidden');
            }
        }
        
        function openAddSkinModal(index = null) {
            editingSkinIndex = index;
            document.getElementById('addSkinModalTitle').textContent = index !== null ? 'Редактировать скин' : 'Добавить скин';
            
            // Очищаем или заполняем поля формы
            if (index !== null) {
                const skin = mySkins[index];
                document.getElementById('newSkinName').value = skin.name;
                document.getElementById('newSkinBuyPrice').value = skin.buyPrice;
                document.getElementById('newSkinDate').value = skin.date;
            } else {
                document.getElementById('newSkinName').value = '';
                document.getElementById('newSkinBuyPrice').value = '';
                document.getElementById('newSkinDate').value = new Date().toISOString().split('T')[0];
            }
            
            document.getElementById('addSkinModal').style.display = 'block';
        }
        
        function closeAddSkinModal() {
            document.getElementById('addSkinModal').style.display = 'none';
            restoreTransactionsView(); // Восстанавливаем выбранный вид
        }
        
        function saveSkin() {
            const name = document.getElementById('newSkinName').value.trim();
            const buyPrice = parseFloat(document.getElementById('newSkinBuyPrice').value);
            const date = document.getElementById('newSkinDate').value || new Date().toISOString().split('T')[0];
            
            if (!name) {
                showNotification('Введите название скина', 'error');
                return;
            }
            
            if (isNaN(buyPrice) || buyPrice <= 0) {
                showNotification('Введите корректную цену покупки', 'error');
                return;
            }
            
            const skin = {
                name,
                buyPrice,
                date
            };
            
            if (editingSkinIndex !== null) {
                mySkins[editingSkinIndex] = skin;
                showNotification('Скин успешно обновлен', 'success');
            } else {
                mySkins.push(skin);
                showNotification('Скин успешно добавлен', 'success');
            }
            
            localStorage.setItem('mySkins', JSON.stringify(mySkins));
            closeAddSkinModal();
            updateMySkinsList();
        }
        
        function updateMySkinsList() {
            const container = document.getElementById('mySkinsList');
            container.innerHTML = '';
            
            if (mySkins.length === 0) {
                container.innerHTML = '<p class="text-center">У вас пока нет сохраненных скинов.</p>';
                return;
            }
            
            mySkins.forEach((skin, index) => {
                const item = document.createElement('div');
                item.className = 'skin-item';
                
                item.innerHTML = `
                    <h3>${skin.name}</h3>
                    <p>Цена покупки: $${skin.buyPrice.toLocaleString()}</p>
                    <p>Дата покупки: ${formatDate(skin.date)}</p>
                    <div class="skin-actions">
                        <button class="btn btn-primary" onclick="openAddSaleModal(${index})">Добавить продажу</button>
                        <button class="btn btn-secondary" onclick="openAddSkinModal(${index})">Редактировать</button>
                        <button class="btn btn-danger" onclick="deleteSkin(${index})">Удалить</button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function deleteSkin(index) {
            skinToDeleteIndex = index;
            document.getElementById('deleteSkinConfirmModal').style.display = 'block';
        }
        
        function closeDeleteSkinConfirmModal() {
            document.getElementById('deleteSkinConfirmModal').style.display = 'none';
        }
        
        function confirmDeleteSkin() {
            console.log('confirmDeleteSkin вызвана, skinToDeleteIndex =', skinToDeleteIndex);
            if (skinToDeleteIndex !== null) {
                mySkins.splice(skinToDeleteIndex, 1);
                localStorage.setItem('mySkins', JSON.stringify(mySkins));
                updateMySkinsList();
                showNotification('Скин удален', 'success');
                closeDeleteSkinConfirmModal();
                skinToDeleteIndex = null;
            }
        }
        
        function openAddSaleModal(index) {
            currentSaleSkinIndex = index;
            const skin = mySkins[index];
            
            document.getElementById('saleModalSkinName').value = skin.name;
            document.getElementById('saleModalBuyPrice').value = skin.buyPrice;
            document.getElementById('saleModalSellPrice').value = '';
            document.getElementById('saleModalDate').value = new Date().toISOString().split('T')[0];
            
            // Сбрасываем результат расчета
            document.getElementById('saleCalculationResult').style.display = 'none';
            lastCalculatedSaleProfit = 0;
            
            // Добавляем автоматический расчет при вводе цены продажи
            const sellPriceInput = document.getElementById('saleModalSellPrice');
            
            // Удаляем предыдущий обработчик, если он был
            sellPriceInput.removeEventListener('input', autoCalculateSaleProfit);
            
            // Добавляем новый обработчик
            sellPriceInput.addEventListener('input', autoCalculateSaleProfit);
            
            document.getElementById('addSaleModal').style.display = 'block';
        }
        
        // Функция для автоматического расчета прибыли при вводе цены продажи
        function autoCalculateSaleProfit() {
            const sellPrice = parseFloat(this.value);
            const buyPrice = parseFloat(document.getElementById('saleModalBuyPrice').value);
            
            if (!isNaN(sellPrice) && !isNaN(buyPrice) && sellPrice > 0) {
                calculateSaleProfit();
            }
        }
        
        function closeAddSaleModal() {
            document.getElementById('addSaleModal').style.display = 'none';
            restoreTransactionsView(); // Восстанавливаем выбранный вид
        }
        
        function calculateSaleProfit() {
            const buyPrice = parseFloat(document.getElementById('saleModalBuyPrice').value);
            const sellPrice = parseFloat(document.getElementById('saleModalSellPrice').value);
            const commission = parseFloat(document.getElementById('saleModalCommission').value);
            
            if (isNaN(sellPrice) || sellPrice <= 0) {
                showNotification('Введите корректную цену продажи', 'error');
                return;
            }
            
            // Расчет прибыли с учетом комиссии
            const commissionAmount = (sellPrice * commission) / 100;
            const profit = sellPrice - buyPrice - commissionAmount;
            const profitPercent = ((profit / buyPrice) * 100).toFixed(2);
            
            lastCalculatedSaleProfit = profit;
            
            // Отображаем результат расчета
            const resultElement = document.getElementById('saleCalculationResult');
            resultElement.style.display = 'block';
            
            if (profit > 0) {
                resultElement.innerHTML = `
                    <p style="color: var(--success)"><strong>Прибыль: $${profit.toLocaleString()} (${profitPercent}%)</strong></p>
                    <p>Комиссия: $${commissionAmount.toLocaleString()} (${commission}%)</p>
                `;
                resultElement.style.borderLeft = '4px solid var(--success)';
            } else {
                resultElement.innerHTML = `
                    <p style="color: var(--danger)"><strong>Убыток: $${Math.abs(profit).toLocaleString()} (${profitPercent}%)</strong></p>
                    <p>Комиссия: $${commissionAmount.toLocaleString()} (${commission}%)</p>
                `;
                resultElement.style.borderLeft = '4px solid var(--danger)';
            }
        }
        
        function saveSale() {
            // Если прибыль еще не рассчитана, автоматически вызываем расчет
            if (lastCalculatedSaleProfit === 0) {
                calculateSaleProfit();
            }
            
            if (lastCalculatedSaleProfit === 0 && !confirm('Прибыль равна 0. Вы уверены, что хотите добавить эту сделку?')) {
                return;
            }
            
            const skin = mySkins[currentSaleSkinIndex];
            const skinName = skin.name;
            const buyPrice = parseFloat(document.getElementById('saleModalBuyPrice').value);
            const sellPrice = parseFloat(document.getElementById('saleModalSellPrice').value);
            const commission = parseFloat(document.getElementById('saleModalCommission').value);
            const date = document.getElementById('saleModalDate').value || new Date().toISOString().split('T')[0];
            const profitPercent = ((lastCalculatedSaleProfit / buyPrice) * 100).toFixed(2);
            
            if (isNaN(sellPrice) || sellPrice <= 0) {
                showNotification('Введите корректную цену продажи', 'error');
                return;
            }
            
            // Создаем транзакцию для добавления в основной список
            const transaction = {
                type: lastCalculatedSaleProfit >= 0 ? 'income' : 'expense',
                amount: Math.abs(lastCalculatedSaleProfit),
                description: `${skinName} (${lastCalculatedSaleProfit >= 0 ? 'прибыль' : 'убыток'}: $${Math.abs(lastCalculatedSaleProfit).toLocaleString()})`,
                date: date,
                theme: skinName,
                buyPrice: buyPrice,
                sellPrice: sellPrice,
                commission: commission,
                profitPercent: Math.abs(profitPercent)
            };
            
            // Добавляем транзакцию в основной список
            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            // Удаляем скин из списка Мои скины
            mySkins.splice(currentSaleSkinIndex, 1);
            localStorage.setItem('mySkins', JSON.stringify(mySkins));
            
            // Обновляем интерфейс
            updateUI();
            closeAddSaleModal();
            updateMySkinsList();
            
            // Показываем уведомление
            showNotification('Сделка успешно добавлена', 'success');
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Функция для привязки обработчиков событий автоматического расчета
        function bindAutoCalculateEvents() {
            // Автоматический расчет при вводе цены продажи
            document.getElementById('sellPrice').addEventListener('input', function() {
                const skinName = document.getElementById('skinName').value;
                const buyPrice = parseFloat(document.getElementById('buyPrice').value);
                const sellPrice = parseFloat(this.value);
                
                if (skinName && !isNaN(buyPrice) && !isNaN(sellPrice)) {
                    calculateProfit();
                }
            });
            
            // Автоматический перерасчет при изменении комиссии
            document.getElementById('profitPercentage').addEventListener('change', function() {
                const skinName = document.getElementById('skinName').value;
                const buyPrice = parseFloat(document.getElementById('buyPrice').value);
                const sellPrice = parseFloat(document.getElementById('sellPrice').value);
                
                if (skinName && !isNaN(buyPrice) && !isNaN(sellPrice)) {
                    calculateProfit();
                }
            });
            
            // Перерасчет при изменении комиссии в окне продажи скина
            document.getElementById('saleModalCommission').addEventListener('change', function() {
                const sellPrice = parseFloat(document.getElementById('saleModalSellPrice').value);
                const buyPrice = parseFloat(document.getElementById('saleModalBuyPrice').value);
                
                if (!isNaN(sellPrice) && !isNaN(buyPrice) && sellPrice > 0) {
                    calculateSaleProfit();
                }
            });
        }

        function toggleTransactionsView() {
            const transactionsList = document.getElementById('transactions');
            const transactionsGrid = document.getElementById('transactionsGrid');
            const viewToggleBtn = document.getElementById('viewToggleBtn');
            
            // Переключаем отображение
            const isListView = transactionsList.style.display !== 'none';
            
            if (isListView) {
                // Переключаемся на сетку
                transactionsList.style.display = 'none';
                transactionsGrid.style.display = 'grid';
                viewToggleBtn.innerHTML = '<i class="fas fa-th"></i> Карточки';
                viewToggleBtn.classList.remove('active');
                localStorage.setItem('transactionsView', 'grid');
            } else {
                // Переключаемся на список
                transactionsList.style.display = 'flex';
                transactionsGrid.style.display = 'none';
                viewToggleBtn.innerHTML = '<i class="fas fa-list"></i> Список';
                viewToggleBtn.classList.add('active');
                localStorage.setItem('transactionsView', 'list');
            }
            
            // Обновляем отображение транзакций
            renderTransactions();
            
            // Добавляем эффект искр вокруг кнопки
            createSparklesAround(viewToggleBtn, 10);
        }

        function renderTransactions() {
            const listContainer = document.getElementById('transactions');
            const gridContainer = document.getElementById('transactionsGrid');
            
            // Очищаем контейнеры
            listContainer.innerHTML = '';
            gridContainer.innerHTML = '';
            
            // Загружаем текущий вид отображения
            const currentView = localStorage.getItem('transactionsView') || 'list';
            
            // Отображаем транзакции в выбранном виде
            transactions.forEach((t, i) => {
                // Показываем проценты только если есть данные о покупке и продаже
                const showPercent = t.buyPrice && t.sellPrice && t.profitPercent;
                
                // Общие элементы для обоих видов
                const amount = `${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString()}
                    ${showPercent ? `<span class="profit-percent">(${t.type === 'income' ? '+' : '-'}${t.profitPercent}%)</span>` : ''}`;
                    
                // Формируем элемент для списка
                const listItem = document.createElement('div');
                listItem.className = 'transaction-item';
                listItem.dataset.index = i;
                listItem.innerHTML = `
                    <div class="transaction-info">
                        <h4>${t.description}</h4>
                        <small>${new Date(t.date).toLocaleDateString()}</small>
                    </div>
                    <div class="transaction-actions">
                        <span class="transaction-amount ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${amount}
                        </span>
                        <button onclick="editTransaction(${i})" class="btn btn-secondary btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button onclick="confirmDelete(${i})" class="btn btn-secondary btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
                listContainer.appendChild(listItem);
                
                // Формируем элемент для сетки
                const gridItem = document.createElement('div');
                gridItem.className = `transaction-card ${t.type}`;
                gridItem.dataset.index = i;
                
                // Анализируем название скина, если оно есть
                let skinInfo = '';
                if (t.skinName) {
                    const parsedSkin = parseSkinName(t.skinName);
                    skinInfo = `
                        <div class="skin-info">
                            ${parsedSkin.weapon ? `<div class="skin-weapon">${parsedSkin.weapon}</div>` : ''}
                            <div class="skin-name">${parsedSkin.name}</div>
                            ${parsedSkin.quality ? `<div class="skin-quality ${parsedSkin.qualityClass}">${parsedSkin.quality}</div>` : ''}
                        </div>
                    `;
                } else if (t.theme) {
                    // Для обратной совместимости со старыми транзакциями
                    const parsedSkin = parseSkinName(t.theme);
                    skinInfo = `
                        <div class="skin-info">
                            ${parsedSkin.weapon ? `<div class="skin-weapon">${parsedSkin.weapon}</div>` : ''}
                            <div class="skin-name">${parsedSkin.name}</div>
                            ${parsedSkin.quality ? `<div class="skin-quality ${parsedSkin.qualityClass}">${parsedSkin.quality}</div>` : ''}
                        </div>
                    `;
                }
                
                gridItem.innerHTML = `
                    <div class="transaction-info">
                        <small>${new Date(t.date).toLocaleDateString()}</small>
                        ${skinInfo}
                        <div class="transaction-amount ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString()}
                            ${showPercent ? `<span class="profit-percent">(${t.type === 'income' ? '+' : '-'}${t.profitPercent}%)</span>` : ''}
                        </div>
                    </div>
                    <div class="transaction-actions">
                        <button onclick="editTransaction(${i})" class="btn btn-secondary btn-icon" title="Редактировать">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button onclick="confirmDelete(${i})" class="btn btn-secondary btn-icon" title="Удалить">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
                gridContainer.appendChild(gridItem);
            });

            // Add animation delay to each transaction item
            const listItems = document.querySelectorAll('.transaction-item');
            listItems.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.05}s`;
                
                // Add hover effect listeners for sparkles
                item.addEventListener('mouseenter', function() {
                    createSparklesAround(this, 5);
                });
            });
            
            // Add animation delay to each transaction card
            const gridItems = document.querySelectorAll('.transaction-card');
            gridItems.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.05}s`;
                
                // Add hover effect listeners for sparkles
                item.addEventListener('mouseenter', function() {
                    createSparklesAround(this, 5);
                });
            });
            
            // Показываем правильный вид при инициализации
            if (currentView === 'grid') {
                const viewToggleBtn = document.getElementById('viewToggleBtn');
                viewToggleBtn.innerHTML = '<i class="fas fa-th"></i> Карточки';
                viewToggleBtn.classList.remove('active');
                listContainer.style.display = 'none';
                gridContainer.style.display = 'grid';
            }
        }

        function filterTransactions() {
            const searchDate = document.getElementById('searchDate').value;
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const searchAmount = document.getElementById('searchAmount').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            // Фильтрация по критериям
            let filteredTransactions = [...transactions];
            
            if (searchDate) {
                filteredTransactions = filteredTransactions.filter(t => t.date === searchDate);
            }
            
            if (searchName) {
                filteredTransactions = filteredTransactions.filter(t => 
                    t.description && t.description.toLowerCase().includes(searchName)
                );
            }
            
            if (searchAmount) {
                const amount = parseFloat(searchAmount);
                filteredTransactions = filteredTransactions.filter(t => 
                    t.amount === amount || 
                    Math.abs(t.amount - amount) < 0.01 // Для неточного совпадения
                );
            }
            
            // Сортировка
            switch (sortOrder) {
                case 'newest':
                    filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'oldest':
                    filteredTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'highest':
                    filteredTransactions.sort((a, b) => b.amount - a.amount);
                    break;
                case 'lowest':
                    filteredTransactions.sort((a, b) => a.amount - b.amount);
                    break;
                case 'profitable':
                    // Фильтрация только прибыльных сделок (income)
                    filteredTransactions = filteredTransactions.filter(t => t.type === 'income');
                    // Сортировка по проценту прибыли (если есть) или по сумме
                    filteredTransactions.sort((a, b) => {
                        if (a.profitPercent && b.profitPercent) {
                            return parseFloat(b.profitPercent) - parseFloat(a.profitPercent);
                        }
                        return b.amount - a.amount;
                    });
                    break;
                case 'unprofitable':
                    // Фильтрация только убыточных сделок (expense)
                    filteredTransactions = filteredTransactions.filter(t => t.type === 'expense');
                    // Сортировка по проценту убытка (если есть) или по сумме
                    filteredTransactions.sort((a, b) => {
                        if (a.profitPercent && b.profitPercent) {
                            return parseFloat(b.profitPercent) - parseFloat(a.profitPercent);
                        }
                        return b.amount - a.amount;
                    });
                    break;
            }
            
            const listContainer = document.getElementById('transactions');
            const gridContainer = document.getElementById('transactionsGrid');
            
            if (filteredTransactions.length === 0) {
                const noTransactionsMsg = `
                    <div class="transaction-item" style="justify-content: center; text-align: center;">
                        <p>Нет транзакций по заданным критериям</p>
                    </div>
                `;
                listContainer.innerHTML = noTransactionsMsg;
                gridContainer.innerHTML = noTransactionsMsg;
                return;
            }
            
            // Очищаем контейнеры
            listContainer.innerHTML = '';
            gridContainer.innerHTML = '';
            
            // Отображаем отфильтрованные транзакции
            filteredTransactions.forEach((t, i) => {
                // Показываем проценты только если есть данные о покупке и продаже
                const showPercent = t.buyPrice && t.sellPrice && t.profitPercent;
                
                // Общие элементы для обоих видов
                const amount = `${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString()}
                    ${showPercent ? `<span class="profit-percent">(${t.type === 'income' ? '+' : '-'}${t.profitPercent}%)</span>` : ''}`;
                    
                // Формируем элемент для списка
                const listItem = document.createElement('div');
                listItem.className = 'transaction-item';
                listItem.dataset.index = transactions.indexOf(t);
                listItem.innerHTML = `
                    <div class="transaction-info">
                        <h4>${t.description}</h4>
                        <small>${new Date(t.date).toLocaleDateString()}</small>
                    </div>
                    <div class="transaction-actions">
                        <span class="transaction-amount ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${amount}
                        </span>
                        <button onclick="editTransaction(${transactions.indexOf(t)})" class="btn btn-secondary btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button onclick="confirmDelete(${transactions.indexOf(t)})" class="btn btn-secondary btn-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
                listContainer.appendChild(listItem);
                
                // Формируем элемент для сетки
                const gridItem = document.createElement('div');
                gridItem.className = `transaction-card ${t.type}`;
                gridItem.dataset.index = transactions.indexOf(t);
                gridItem.innerHTML = `
                    <div class="transaction-info">
                        <h4>${t.description}</h4>
                        <small>${new Date(t.date).toLocaleDateString()}</small>
                        <div class="transaction-amount ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString()}
                            ${showPercent ? `<span class="profit-percent">(${t.type === 'income' ? '+' : '-'}${t.profitPercent}%)</span>` : ''}
                        </div>
                    </div>
                    <div class="transaction-actions">
                        <button onclick="editTransaction(${transactions.indexOf(t)})" class="btn btn-secondary btn-icon" title="Редактировать">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button onclick="confirmDelete(${transactions.indexOf(t)})" class="btn btn-secondary btn-icon" title="Удалить">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
                gridContainer.appendChild(gridItem);
            });
            
            // Add animation to filtered items
            const listItems = document.querySelectorAll('.transaction-item');
            listItems.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.05}s`;
                
                // Add hover effect listeners for sparkles
                item.addEventListener('mouseenter', function() {
                    createSparklesAround(this, 5);
                });
            });
            
            // Add animation to filtered grid items
            const gridItems = document.querySelectorAll('.transaction-card');
            gridItems.forEach((item, index) => {
                item.style.animationDelay = `${index * 0.05}s`;
                
                // Add hover effect listeners for sparkles
                item.addEventListener('mouseenter', function() {
                    createSparklesAround(this, 5);
                });
            });
        }

        // Загрузим сохраненный вид при инициализации
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Загружаем сохраненный вид отображения
            restoreTransactionsView();
            
            // Обновляем интерфейс
            updateUI();
        });

        // Функция для восстановления выбранного вида после модального окна
        function restoreTransactionsView() {
            const currentView = localStorage.getItem('transactionsView') || 'list';
            const transactionsList = document.getElementById('transactions');
            const transactionsGrid = document.getElementById('transactionsGrid');
            const viewToggleBtn = document.getElementById('viewToggleBtn');
            
            if (currentView === 'grid') {
                // Отображаем сетку
                transactionsList.style.display = 'none';
                transactionsGrid.style.display = 'grid';
                viewToggleBtn.innerHTML = '<i class="fas fa-th"></i> Карточки';
                viewToggleBtn.classList.remove('active');
            } else {
                // Отображаем список
                transactionsList.style.display = 'flex';
                transactionsGrid.style.display = 'none';
                viewToggleBtn.innerHTML = '<i class="fas fa-list"></i> Список';
                viewToggleBtn.classList.add('active');
            }
        }

        /**
         * Парсит название скина на составляющие: оружие, название скина и качество
         * @param {string} fullSkinName - Полное название скина
         * @return {Object} Объект с полями weapon, name, quality
         */
        function parseSkinName(fullSkinName) {
            if (!fullSkinName) {
                return { weapon: '', name: '', quality: '' };
            }
            
            // Результат по умолчанию
            let result = { 
                weapon: '', 
                name: fullSkinName, 
                quality: '',
                qualityClass: ''
            };
            
            // Качества скинов и соответствующие CSS классы
            const qualities = [
                { text: 'Factory New', shortText: 'FN', class: 'quality-fn' },
                { text: 'Minimal Wear', shortText: 'MW', class: 'quality-mw' },
                { text: 'Field-Tested', shortText: 'FT', class: 'quality-ft' },
                { text: 'Well-Worn', shortText: 'WW', class: 'quality-ww' },
                { text: 'Battle-Scarred', shortText: 'BS', class: 'quality-bs' }
            ];
            
            // Поиск качества
            for (const quality of qualities) {
                if (fullSkinName.includes(quality.text) || 
                    fullSkinName.includes(`(${quality.shortText})`) || 
                    fullSkinName.includes(quality.shortText)) {
                    result.quality = quality.text;
                    result.qualityClass = quality.class;
                    break;
                }
            }
            
            // Разделение на оружие и имя скина (если есть разделитель "|")
            if (fullSkinName.includes('|')) {
                const parts = fullSkinName.split('|').map(part => part.trim());
                result.weapon = parts[0];
                result.name = parts[1];
                
                // Удаляем качество из названия скина если оно есть
                if (result.quality) {
                    result.name = result.name.replace(`(${result.quality})`, '').trim();
                }
            } else {
                // Если разделителя нет, пробуем определить по известным оружиям
                const weapons = ['AK-47', 'M4A4', 'M4A1-S', 'AWP', 'Desert Eagle', 'USP-S', 'P250', 'Glock-18', 'Five-SeveN', 'P90', 'MP5-SD', 'MP7', 'MP9', 'MAC-10', 'UMP-45', 'PP-Bizon', 'Galil AR', 'FAMAS', 'SG 553', 'AUG', 'SSG 08', 'G3SG1', 'SCAR-20'];
                
                for (const weapon of weapons) {
                    if (fullSkinName.startsWith(weapon)) {
                        result.weapon = weapon;
                        result.name = fullSkinName.substring(weapon.length).trim();
                        break;
                    }
                }
                
                // Удаляем качество из названия скина если оно есть
                if (result.quality) {
                    result.name = result.name.replace(`(${result.quality})`, '').trim();
                }
            }
            
            return result;
        }
    </script>
    
    <!-- Модальное окно подтверждения удаления скина -->
</body>
</html>